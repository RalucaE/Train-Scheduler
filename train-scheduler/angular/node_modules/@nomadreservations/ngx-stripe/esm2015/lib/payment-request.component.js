import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { BehaviorSubject, combineLatest, ReplaySubject, Subject } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { StripeService } from './services/stripe.service';
let PaymentRequestComponent = class PaymentRequestComponent {
    constructor(stripeService) {
        this.stripeService = stripeService;
        this.change = new EventEmitter();
        this.shippingAddressChange = new EventEmitter();
        this.shippingOptionChange = new EventEmitter();
        this.cancel = new EventEmitter();
        this.hide = false;
        this.styles$ = new BehaviorSubject({});
        this.options$ = new ReplaySubject();
        this.elementsOptions$ = new BehaviorSubject({});
        this.complete$ = new Subject();
        this._attached = false;
        this._opened = false;
    }
    set options(optionsIn) {
        this.options$.next(optionsIn);
    }
    set elementsOptions(optionsIn) {
        this.elementsOptions$.next(optionsIn);
    }
    set styles(optionsIn) {
        this.styles$.next(optionsIn);
    }
    set complete(success) {
        this.complete$.next(success);
    }
    ngOnInit() {
        this.elements$ = this.elementsOptions$.asObservable().pipe(switchMap(options => {
            return this.stripeService.elements(options);
        }));
        this.request$ = this.options$.asObservable().pipe(switchMap(options => {
            return this.stripeService.paymentRequest(options);
        }));
        this.complete$.subscribe(complete => {
            if (this.lastEvent) {
                if (complete) {
                    this.lastEvent.complete('success');
                }
                else {
                    this.lastEvent.complete('fail');
                }
            }
        });
    }
    ngAfterViewInit() {
        combineLatest(this.request$, this.elements$, this.options$, this.styles$).subscribe(([paymentRequest, elements, options, styles]) => {
            if (this.requestButton && !this._attached) {
                this._paymentRequest = paymentRequest;
                this._attached = true;
                const element = elements.create('paymentRequestButton', {
                    paymentRequest,
                    style: {
                        paymentRequestButton: Object.assign({}, styles)
                    }
                });
                this.hide = false;
                paymentRequest.canMakePayment().then(result => {
                    if (result) {
                        element.mount(this.requestButton.nativeElement);
                    }
                    else {
                        this.hide = true;
                    }
                });
                paymentRequest.on('shippingaddresschange', event => {
                    this.shippingAddressChange.emit(event);
                });
                paymentRequest.on('shippingoptionchange', event => {
                    this.shippingOptionChange.emit(event);
                });
                paymentRequest.on('token', event => {
                    this.change.emit(event);
                    this._opened = false;
                });
                paymentRequest.on('paymentmethod', event => {
                    this.change.emit(event);
                });
                paymentRequest.on('source', event => {
                    this.change.emit(event);
                });
                paymentRequest.on('cancel', event => {
                    this.cancel.emit(event);
                    this._opened = false;
                });
                paymentRequest.on('click', () => {
                    this._opened = true;
                });
            }
            else if (this._attached && !this._opened) {
                this._paymentRequest.update({
                    currency: options.currency,
                    total: options.total,
                    displayItems: options.displayItems,
                    shippingOptions: options.shippingOptions
                });
            }
        });
    }
};
PaymentRequestComponent.ctorParameters = () => [
    { type: StripeService }
];
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object),
    tslib_1.__metadata("design:paramtypes", [Object])
], PaymentRequestComponent.prototype, "options", null);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object),
    tslib_1.__metadata("design:paramtypes", [Object])
], PaymentRequestComponent.prototype, "elementsOptions", null);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object),
    tslib_1.__metadata("design:paramtypes", [Object])
], PaymentRequestComponent.prototype, "styles", null);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean),
    tslib_1.__metadata("design:paramtypes", [Boolean])
], PaymentRequestComponent.prototype, "complete", null);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], PaymentRequestComponent.prototype, "change", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], PaymentRequestComponent.prototype, "shippingAddressChange", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], PaymentRequestComponent.prototype, "shippingOptionChange", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], PaymentRequestComponent.prototype, "cancel", void 0);
tslib_1.__decorate([
    ViewChild('request', { static: false }),
    tslib_1.__metadata("design:type", ElementRef)
], PaymentRequestComponent.prototype, "requestButton", void 0);
PaymentRequestComponent = tslib_1.__decorate([
    Component({
        selector: 'ngx-payment-request',
        template: '<div #request [style.display-none]="hide"></div>'
    }),
    tslib_1.__metadata("design:paramtypes", [StripeService])
], PaymentRequestComponent);
export { PaymentRequestComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudC1yZXF1ZXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bub21hZHJlc2VydmF0aW9ucy9uZ3gtc3RyaXBlLyIsInNvdXJjZXMiOlsibGliL3BheW1lbnQtcmVxdWVzdC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBaUIsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckgsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQWMsYUFBYSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxRixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBTTFELElBQWEsdUJBQXVCLEdBQXBDLE1BQWEsdUJBQXVCO0lBcUJsQyxZQUFvQixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUMvQixXQUFNLEdBQUcsSUFBSSxZQUFZLEVBbUJ0QyxDQUFDO1FBQ1ksMEJBQXFCLEdBQUcsSUFBSSxZQUFZLEVBR3JELENBQUM7UUFDWSx5QkFBb0IsR0FBRyxJQUFJLFlBQVksRUFHcEQsQ0FBQztRQUNZLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBRTNDLFNBQUksR0FBRyxLQUFLLENBQUM7UUFHWixZQUFPLEdBQUcsSUFBSSxlQUFlLENBQTRCLEVBQUUsQ0FBQyxDQUFDO1FBQzdELGFBQVEsR0FBRyxJQUFJLGFBQWEsRUFBeUIsQ0FBQztRQUN0RCxxQkFBZ0IsR0FBRyxJQUFJLGVBQWUsQ0FBa0IsRUFBRSxDQUFDLENBQUM7UUFFNUQsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFDbkMsY0FBUyxHQUFHLEtBQUssQ0FBQztRQUNsQixZQUFPLEdBQUcsS0FBSyxDQUFDO0lB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QUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDO29CQUMxQixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7b0JBQzFCLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSztvQkFDcEIsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZO29CQUNsQyxlQUFlLEVBQUUsT0FBTyxDQUFDLGVBQWU7aUJBQ3pDLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUNGLENBQUM7SUFDSixDQUFDO0NBQ0YsQ0FBQTs7WUEzSG9DLGFBQWE7O0FBbkJoRDtJQURDLEtBQUssRUFBRTs7O3NEQUdQO0FBR0Q7SUFEQyxLQUFLLEVBQUU7Ozs4REFHUDtBQUdEO0lBREMsS0FBSyxFQUFFOzs7cURBR1A7QUFHRDtJQURDLEtBQUssRUFBRTs7O3VEQUdQO0FBR1M7SUFBVCxNQUFNLEVBQUU7O3VEQW1CSjtBQUNLO0lBQVQsTUFBTSxFQUFFOztzRUFHSjtBQUNLO0lBQVQsTUFBTSxFQUFFOztxRUFHSjtBQUNLO0lBQVQsTUFBTSxFQUFFOzt1REFBeUM7QUFJVDtJQUF4QyxTQUFTLENBQUMsU0FBUyxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDO3NDQUF5QixVQUFVOzhEQUFDO0FBdERqRSx1QkFBdUI7SUFKbkMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLHFCQUFxQjtRQUMvQixRQUFRLEVBQUUsa0RBQWtEO0tBQzdELENBQUM7NkNBc0JtQyxhQUFhO0dBckJyQyx1QkFBdUIsQ0FnSm5DO1NBaEpZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmdGVyVmlld0luaXQsIENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25Jbml0LCBPdXRwdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0LCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQYXltZW50UmVxdWVzdEJ1dHRvblN0eWxlLCBSZXF1ZXN0RWxlbWVudE9wdGlvbnMsIFVwZGF0ZURldGFpbHMgfSBmcm9tICcuL2ludGVyZmFjZXMvZWxlbWVudCc7XG5pbXBvcnQgeyBFbGVtZW50c09wdGlvbnMgfSBmcm9tICcuL2ludGVyZmFjZXMvZWxlbWVudHMnO1xuaW1wb3J0IHsgU291cmNlIH0gZnJvbSAnLi9pbnRlcmZhY2VzL3NvdXJjZXMnO1xuaW1wb3J0IHsgU2hpcHBpbmdBZGRyZXNzLCBTaGlwcGluZ09wdGlvbnMsIFRva2VuIH0gZnJvbSAnLi9pbnRlcmZhY2VzL3Rva2VuJztcbmltcG9ydCB7IFN0cmlwZVNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3N0cmlwZS5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmd4LXBheW1lbnQtcmVxdWVzdCcsXG4gIHRlbXBsYXRlOiAnPGRpdiAjcmVxdWVzdCBbc3R5bGUuZGlzcGxheS1ub25lXT1cImhpZGVcIj48L2Rpdj4nXG59KVxuZXhwb3J0IGNsYXNzIFBheW1lbnRSZXF1ZXN0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcbiAgQElucHV0KClcbiAgcHJpdmF0ZSBzZXQgb3B0aW9ucyhvcHRpb25zSW46IFJlcXVlc3RFbGVtZW50T3B0aW9ucykge1xuICAgIHRoaXMub3B0aW9ucyQubmV4dChvcHRpb25zSW4pO1xuICB9XG5cbiAgQElucHV0KClcbiAgcHVibGljIHNldCBlbGVtZW50c09wdGlvbnMob3B0aW9uc0luOiBFbGVtZW50c09wdGlvbnMpIHtcbiAgICB0aGlzLmVsZW1lbnRzT3B0aW9ucyQubmV4dChvcHRpb25zSW4pO1xuICB9XG5cbiAgQElucHV0KClcbiAgcHVibGljIHNldCBzdHlsZXMob3B0aW9uc0luOiBQYXltZW50UmVxdWVzdEJ1dHRvblN0eWxlKSB7XG4gICAgdGhpcy5zdHlsZXMkLm5leHQob3B0aW9uc0luKTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBzZXQgY29tcGxldGUoc3VjY2VzczogYm9vbGVhbikge1xuICAgIHRoaXMuY29tcGxldGUkLm5leHQoc3VjY2Vzcyk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHN0cmlwZVNlcnZpY2U6IFN0cmlwZVNlcnZpY2UpIHt9XG4gIEBPdXRwdXQoKSBwdWJsaWMgY2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjx7XG4gICAgdG9rZW4/OiBUb2tlbjtcbiAgICBwYXltZW50TWV0aG9kPzogUGF5bWVudE1ldGhvZERhdGE7XG4gICAgc291cmNlPzogU291cmNlO1xuICAgIGNvbXBsZXRlOiAoXG4gICAgICBzdGF0dXM6XG4gICAgICAgIHwgJ3N1Y2Nlc3MnXG4gICAgICAgIHwgJ2ZhaWwnXG4gICAgICAgIHwgJ2ludmFsaWRfcGF5ZXJfbmFtZSdcbiAgICAgICAgfCAnaW52YWxpZF9wYXllcl9waG9uZSdcbiAgICAgICAgfCAnaW52YWxpZF9wYXllcl9lbWFpbCdcbiAgICAgICAgfCAnaW52YWxpZF9zaGlwcGluZ19hZGRyZXNzJ1xuICAgICkgPT4ge307XG4gICAgcGF5ZXJOYW1lPzogc3RyaW5nO1xuICAgIHBheWVyRW1haWw/OiBzdHJpbmc7XG4gICAgcGF5ZXJQaG9uZT86IHN0cmluZztcbiAgICBzaGlwcGluZ0FkZHJlc3M/OiBTaGlwcGluZ0FkZHJlc3M7XG4gICAgc2hpcHBpbmdPcHRpb24/OiBTaGlwcGluZ09wdGlvbnM7XG4gICAgbWV0aG9kTmFtZT86IHN0cmluZztcbiAgfT4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBzaGlwcGluZ0FkZHJlc3NDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPHtcbiAgICB1cGRhdGVXaXRoOiAodXBkYXRlRGV0YWlsczogVXBkYXRlRGV0YWlscykgPT4ge307XG4gICAgc2hpcHBpbmdBZGRyZXNzOiBTaGlwcGluZ0FkZHJlc3M7XG4gIH0+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgc2hpcHBpbmdPcHRpb25DaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPHtcbiAgICB1cGRhdGVXaXRoOiAodXBkYXRlRGV0YWlsczogVXBkYXRlRGV0YWlscykgPT4ge307XG4gICAgc2hpcHBpbmdPcHRpb246IFNoaXBwaW5nT3B0aW9ucztcbiAgfT4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBjYW5jZWwgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBwdWJsaWMgaGlkZSA9IGZhbHNlO1xuXG4gIEBWaWV3Q2hpbGQoJ3JlcXVlc3QnLCB7IHN0YXRpYzogZmFsc2UgfSkgcHJpdmF0ZSByZXF1ZXN0QnV0dG9uPzogRWxlbWVudFJlZjtcbiAgcHJpdmF0ZSBzdHlsZXMkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxQYXltZW50UmVxdWVzdEJ1dHRvblN0eWxlPih7fSk7XG4gIHByaXZhdGUgb3B0aW9ucyQgPSBuZXcgUmVwbGF5U3ViamVjdDxSZXF1ZXN0RWxlbWVudE9wdGlvbnM+KCk7XG4gIHByaXZhdGUgZWxlbWVudHNPcHRpb25zJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RWxlbWVudHNPcHRpb25zPih7fSk7XG4gIHByaXZhdGUgbGFzdEV2ZW50OiBhbnk7XG4gIHByaXZhdGUgY29tcGxldGUkID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgcHJpdmF0ZSBfYXR0YWNoZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBfb3BlbmVkID0gZmFsc2U7XG4gIHByaXZhdGUgX3BheW1lbnRSZXF1ZXN0OiBhbnk7XG5cbiAgcHJpdmF0ZSBlbGVtZW50cyQ6IE9ic2VydmFibGU8YW55PjtcbiAgcHJpdmF0ZSByZXF1ZXN0JDogT2JzZXJ2YWJsZTxhbnk+O1xuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuZWxlbWVudHMkID0gdGhpcy5lbGVtZW50c09wdGlvbnMkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAob3B0aW9ucyA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0cmlwZVNlcnZpY2UuZWxlbWVudHMob3B0aW9ucyk7XG4gICAgICB9KVxuICAgICk7XG4gICAgdGhpcy5yZXF1ZXN0JCA9IHRoaXMub3B0aW9ucyQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIHN3aXRjaE1hcChvcHRpb25zID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RyaXBlU2VydmljZS5wYXltZW50UmVxdWVzdChvcHRpb25zKTtcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHRoaXMuY29tcGxldGUkLnN1YnNjcmliZShjb21wbGV0ZSA9PiB7XG4gICAgICBpZiAodGhpcy5sYXN0RXZlbnQpIHtcbiAgICAgICAgaWYgKGNvbXBsZXRlKSB7XG4gICAgICAgICAgdGhpcy5sYXN0RXZlbnQuY29tcGxldGUoJ3N1Y2Nlc3MnKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmxhc3RFdmVudC5jb21wbGV0ZSgnZmFpbCcpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIGNvbWJpbmVMYXRlc3QodGhpcy5yZXF1ZXN0JCwgdGhpcy5lbGVtZW50cyQsIHRoaXMub3B0aW9ucyQsIHRoaXMuc3R5bGVzJCkuc3Vic2NyaWJlKFxuICAgICAgKFtwYXltZW50UmVxdWVzdCwgZWxlbWVudHMsIG9wdGlvbnMsIHN0eWxlc10pID0+IHtcbiAgICAgICAgaWYgKHRoaXMucmVxdWVzdEJ1dHRvbiAmJiAhdGhpcy5fYXR0YWNoZWQpIHtcbiAgICAgICAgICB0aGlzLl9wYXltZW50UmVxdWVzdCA9IHBheW1lbnRSZXF1ZXN0O1xuICAgICAgICAgIHRoaXMuX2F0dGFjaGVkID0gdHJ1ZTtcbiAgICAgICAgICBjb25zdCBlbGVtZW50ID0gZWxlbWVudHMuY3JlYXRlKCdwYXltZW50UmVxdWVzdEJ1dHRvbicsIHtcbiAgICAgICAgICAgIHBheW1lbnRSZXF1ZXN0LFxuICAgICAgICAgICAgc3R5bGU6IHtcbiAgICAgICAgICAgICAgcGF5bWVudFJlcXVlc3RCdXR0b246IHsgLi4uc3R5bGVzIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHRoaXMuaGlkZSA9IGZhbHNlO1xuICAgICAgICAgIHBheW1lbnRSZXF1ZXN0LmNhbk1ha2VQYXltZW50KCkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICBlbGVtZW50Lm1vdW50KHRoaXMucmVxdWVzdEJ1dHRvbi5uYXRpdmVFbGVtZW50KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRoaXMuaGlkZSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcGF5bWVudFJlcXVlc3Qub24oJ3NoaXBwaW5nYWRkcmVzc2NoYW5nZScsIGV2ZW50ID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2hpcHBpbmdBZGRyZXNzQ2hhbmdlLmVtaXQoZXZlbnQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHBheW1lbnRSZXF1ZXN0Lm9uKCdzaGlwcGluZ29wdGlvbmNoYW5nZScsIGV2ZW50ID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2hpcHBpbmdPcHRpb25DaGFuZ2UuZW1pdChldmVudCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcGF5bWVudFJlcXVlc3Qub24oJ3Rva2VuJywgZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy5jaGFuZ2UuZW1pdChldmVudCk7XG4gICAgICAgICAgICB0aGlzLl9vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwYXltZW50UmVxdWVzdC5vbigncGF5bWVudG1ldGhvZCcsIGV2ZW50ID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlLmVtaXQoZXZlbnQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHBheW1lbnRSZXF1ZXN0Lm9uKCdzb3VyY2UnLCBldmVudCA9PiB7XG4gICAgICAgICAgICB0aGlzLmNoYW5nZS5lbWl0KGV2ZW50KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwYXltZW50UmVxdWVzdC5vbignY2FuY2VsJywgZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy5jYW5jZWwuZW1pdChldmVudCk7XG4gICAgICAgICAgICB0aGlzLl9vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwYXltZW50UmVxdWVzdC5vbignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9vcGVuZWQgPSB0cnVlO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX2F0dGFjaGVkICYmICF0aGlzLl9vcGVuZWQpIHtcbiAgICAgICAgICB0aGlzLl9wYXltZW50UmVxdWVzdC51cGRhdGUoe1xuICAgICAgICAgICAgY3VycmVuY3k6IG9wdGlvbnMuY3VycmVuY3ksXG4gICAgICAgICAgICB0b3RhbDogb3B0aW9ucy50b3RhbCxcbiAgICAgICAgICAgIGRpc3BsYXlJdGVtczogb3B0aW9ucy5kaXNwbGF5SXRlbXMsXG4gICAgICAgICAgICBzaGlwcGluZ09wdGlvbnM6IG9wdGlvbnMuc2hpcHBpbmdPcHRpb25zXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApO1xuICB9XG59XG4iXX0=