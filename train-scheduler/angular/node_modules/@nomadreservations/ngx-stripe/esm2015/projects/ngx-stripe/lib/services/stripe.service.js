import * as tslib_1 from "tslib";
import { Inject, Injectable } from '@angular/core';
import { from as observableFrom, ReplaySubject } from 'rxjs';
import { filter, map, publishLast, refCount, take } from 'rxjs/operators';
import { isSourceData } from '../interfaces/sources';
import { STRIPE_OPTIONS, STRIPE_PUBLISHABLE_KEY } from '../interfaces/stripe';
import { isBankAccount, isBankAccountData, isPii, isPiiData } from '../interfaces/token';
import { LazyStripeAPILoader, Status } from './api-loader.service';
import { PlatformService } from './platform.service';
import { WindowRef } from './window-ref.service';
let StripeService = class StripeService {
    constructor(key, options, loader, window, _platform) {
        this.key = key;
        this.options = options;
        this.loader = loader;
        this.window = window;
        this._platform = _platform;
        this.stripeChanged$ = new ReplaySubject();
        this.stripe = {};
        this.changeKey(this.key, this.options)
            .pipe(take(1))
            .subscribe(() => { });
    }
    changeKey(key, options) {
        const obs = this.loader.asStream().pipe(filter((status) => status.loaded === true), map(() => {
            if (!this.window.getNativeWindow()) {
                return;
            }
            const Stripe = this.window.getNativeWindow().Stripe;
            if (key) {
                this.stripe = options ? Stripe(key, options) : Stripe(key);
                this.stripeChanged$.next(this.stripe);
            }
            return this.stripe;
        }), publishLast(), refCount());
        obs.subscribe();
        return obs;
    }
    elements(options) {
        return this.stripeChanged$.pipe(map(() => this.stripe.elements(options)));
    }
    createToken(a, b) {
        if (isBankAccount(a) && isBankAccountData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else if (isPii(a) && isPiiData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else {
            return observableFrom(this.stripe.createToken(a, b));
        }
    }
    paymentRequest(options) {
        return this.stripeChanged$.pipe(map(() => this.stripe.paymentRequest(options)));
    }
    handleCardSetup(clientSecret, element, cardSetupOptions) {
        return observableFrom(this.stripe.handleCardSetup(clientSecret, element, cardSetupOptions));
    }
    handleCardPayment(clientSecret, element, cardSetupOptions) {
        return observableFrom(this.stripe.handleCardPayment(clientSecret, element, cardSetupOptions));
    }
    handleCardAction(clientSecret) {
        return observableFrom(this.stripe.handleCardAction(clientSecret));
    }
    confirmPaymentIntent(clientSecret, element, intentOptions) {
        return observableFrom(this.stripe.confirmPaymentIntent(clientSecret, element, intentOptions));
    }
    confirmCardPayment(clientSecret, data, options) {
        return observableFrom(this.stripe.confirmCardPayment(clientSecret, data, options));
    }
    retrievePaymentIntent(clientSecret) {
        return observableFrom(this.stripe.retrievePaymentIntent(clientSecret));
    }
    retrieveSetupIntent(clientSecret) {
        return observableFrom(this.stripe.retrieveSetupIntent(clientSecret));
    }
    confirmSetupIntent(clientSecret, element, intentOptions) {
        return observableFrom(this.stripe.confirmSetupIntent(clientSecret, element, intentOptions));
    }
    createSource(a, b) {
        if (isSourceData(a)) {
            return observableFrom(this.stripe.createSource(a));
        }
        return observableFrom(this.stripe.createSource(a, b));
    }
    retrieveSource(source) {
        return observableFrom(this.stripe.retrieveSource(source));
    }
    createPaymentMethod(paymentMethod) {
        return observableFrom(this.stripe.createPaymentMethod(paymentMethod));
    }
};
StripeService.ctorParameters = () => [
    { type: String, decorators: [{ type: Inject, args: [STRIPE_PUBLISHABLE_KEY,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [STRIPE_OPTIONS,] }] },
    { type: LazyStripeAPILoader },
    { type: WindowRef },
    { type: PlatformService }
];
StripeService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(0, Inject(STRIPE_PUBLISHABLE_KEY)),
    tslib_1.__param(1, Inject(STRIPE_OPTIONS)),
    tslib_1.__metadata("design:paramtypes", [String, Object, LazyStripeAPILoader,
        WindowRef,
        PlatformService])
], StripeService);
export { StripeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abm9tYWRyZXNlcnZhdGlvbnMvbmd4LXN0cmlwZS9wcm9qZWN0cy9uZ3gtc3RyaXBlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3N0cmlwZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFHQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsSUFBSSxJQUFJLGNBQWMsRUFBYyxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDekUsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUcxRSxPQUFPLEVBQUUsWUFBWSxFQUEwQyxNQUFNLHVCQUF1QixDQUFDO0FBQzdGLE9BQU8sRUFBcUIsY0FBYyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDakcsT0FBTyxFQVVMLGFBQWEsRUFDYixpQkFBaUIsRUFDakIsS0FBSyxFQUNMLFNBQVMsRUFPVixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR2pELElBQWEsYUFBYSxHQUExQixNQUFhLGFBQWE7SUFJeEIsWUFDMEMsR0FBVyxFQUNuQixPQUFnQixFQUN4QyxNQUEyQixFQUMzQixNQUFpQixFQUNqQixTQUEwQjtRQUpNLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDbkIsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUN4QyxXQUFNLEdBQU4sTUFBTSxDQUFxQjtRQUMzQixXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQ2pCLGNB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T0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUM7SUFDOUYsQ0FBQztJQUVNLFlBQVksQ0FBQyxDQUF1QixFQUFFLENBQTBCO1FBQ3JFLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ25CLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQWUsQ0FBQyxDQUFDLENBQUM7U0FDbEU7UUFDRCxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRU0sY0FBYyxDQUFDLE1BQW9CO1FBQ3hDLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUVNLG1CQUFtQixDQUFDLGFBQWtDO1FBQzNELE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztJQUN4RSxDQUFDO0NBQ0YsQ0FBQTs7eUNBdkhJLE1BQU0sU0FBQyxzQkFBc0I7NENBQzdCLE1BQU0sU0FBQyxjQUFjO1lBQ04sbUJBQW1CO1lBQ25CLFNBQVM7WUFDTixlQUFlOztBQVR6QixhQUFhO0lBRHpCLFVBQVUsRUFBRTtJQU1SLG1CQUFBLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBO0lBQzlCLG1CQUFBLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQTs2REFDUCxtQkFBbUI7UUFDbkIsU0FBUztRQUNOLGVBQWU7R0FUekIsYUFBYSxDQTRIekI7U0E1SFksYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBheW1lbnRNZXRob2RQYXJhbXMsIFBheW1lbnRNZXRob2RSZXN1bHQgfSBmcm9tICcuLy4uL2ludGVyZmFjZXMvcGF5bWVudC1tZXRob2QnO1xuZGVjbGFyZSB2YXIgU3RyaXBlO1xuXG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb20gYXMgb2JzZXJ2YWJsZUZyb20sIE9ic2VydmFibGUsIFJlcGxheVN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBwdWJsaXNoTGFzdCwgcmVmQ291bnQsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBFbGVtZW50LCBSZXF1ZXN0RWxlbWVudE9wdGlvbnMgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2VsZW1lbnQnO1xuaW1wb3J0IHsgRWxlbWVudHMsIEVsZW1lbnRzT3B0aW9ucyB9IGZyb20gJy4uL2ludGVyZmFjZXMvZWxlbWVudHMnO1xuaW1wb3J0IHsgaXNTb3VyY2VEYXRhLCBTb3VyY2VEYXRhLCBTb3VyY2VQYXJhbXMsIFNvdXJjZVJlc3VsdCB9IGZyb20gJy4uL2ludGVyZmFjZXMvc291cmNlcyc7XG5pbXBvcnQgeyBPcHRpb25zLCBTdHJpcGVKUywgU1RSSVBFX09QVElPTlMsIFNUUklQRV9QVUJMSVNIQUJMRV9LRVkgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3N0cmlwZSc7XG5pbXBvcnQge1xuICBCYW5rQWNjb3VudCxcbiAgQmFua0FjY291bnREYXRhLFxuICBDYXJkRGF0YU9wdGlvbnMsXG4gIENhcmRQYXltZW50RGF0YSxcbiAgQ29uZmlybUNhcmRQYXltZW50RGF0YSxcbiAgQ29uZmlybUNhcmRQYXltZW50T3B0aW9ucyxcbiAgQ29uZmlybUNhcmRQYXltZW50UmVzdWx0LFxuICBDb25maXJtSW50ZW50RGF0YSxcbiAgQ29uZmlybVNldHVwSW50ZW50RGF0YSxcbiAgaXNCYW5rQWNjb3VudCxcbiAgaXNCYW5rQWNjb3VudERhdGEsXG4gIGlzUGlpLFxuICBpc1BpaURhdGEsXG4gIFBheW1lbnRJbnRlbnRSZXN1bHQsXG4gIFBpaSxcbiAgUGlpRGF0YSxcbiAgU2V0dXBJbnRlbnREYXRhLFxuICBTZXR1cEludGVudFJlc3VsdCxcbiAgVG9rZW5SZXN1bHRcbn0gZnJvbSAnLi4vaW50ZXJmYWNlcy90b2tlbic7XG5pbXBvcnQgeyBMYXp5U3RyaXBlQVBJTG9hZGVyLCBTdGF0dXMgfSBmcm9tICcuL2FwaS1sb2FkZXIuc2VydmljZSc7XG5pbXBvcnQgeyBQbGF0Zm9ybVNlcnZpY2UgfSBmcm9tICcuL3BsYXRmb3JtLnNlcnZpY2UnO1xuaW1wb3J0IHsgV2luZG93UmVmIH0gZnJvbSAnLi93aW5kb3ctcmVmLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU3RyaXBlU2VydmljZSB7XG4gIHB1YmxpYyBzdHJpcGVDaGFuZ2VkJDogUmVwbGF5U3ViamVjdDxTdHJpcGVKUz4gPSBuZXcgUmVwbGF5U3ViamVjdCgpO1xuICBwcml2YXRlIHN0cmlwZTogU3RyaXBlSlMgPSB7fSBhcyBTdHJpcGVKUztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KFNUUklQRV9QVUJMSVNIQUJMRV9LRVkpIHByaXZhdGUga2V5OiBzdHJpbmcsXG4gICAgQEluamVjdChTVFJJUEVfT1BUSU9OUykgcHJpdmF0ZSBvcHRpb25zOiBPcHRpb25zLFxuICAgIHByaXZhdGUgbG9hZGVyOiBMYXp5U3RyaXBlQVBJTG9hZGVyLFxuICAgIHByaXZhdGUgd2luZG93OiBXaW5kb3dSZWYsXG4gICAgcHJpdmF0ZSBfcGxhdGZvcm06IFBsYXRmb3JtU2VydmljZVxuICApIHtcbiAgICB0aGlzLmNoYW5nZUtleSh0aGlzLmtleSwgdGhpcy5vcHRpb25zKVxuICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge30pO1xuICB9XG5cbiAgcHVibGljIGNoYW5nZUtleShrZXk6IHN0cmluZywgb3B0aW9ucz86IE9wdGlvbnMpOiBPYnNlcnZhYmxlPFN0cmlwZUpTIHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3Qgb2JzID0gdGhpcy5sb2FkZXIuYXNTdHJlYW0oKS5waXBlKFxuICAgICAgZmlsdGVyKChzdGF0dXM6IFN0YXR1cykgPT4gc3RhdHVzLmxvYWRlZCA9PT0gdHJ1ZSksXG4gICAgICBtYXAoKCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMud2luZG93LmdldE5hdGl2ZVdpbmRvdygpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IFN0cmlwZSA9ICh0aGlzLndpbmRvdy5nZXROYXRpdmVXaW5kb3coKSBhcyBhbnkpLlN0cmlwZTtcbiAgICAgICAgaWYgKGtleSkge1xuICAgICAgICAgIHRoaXMuc3RyaXBlID0gb3B0aW9ucyA/IChTdHJpcGUoa2V5LCBvcHRpb25zKSBhcyBTdHJpcGVKUykgOiAoU3RyaXBlKGtleSkgYXMgU3RyaXBlSlMpO1xuICAgICAgICAgIHRoaXMuc3RyaXBlQ2hhbmdlZCQubmV4dCh0aGlzLnN0cmlwZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuc3RyaXBlO1xuICAgICAgfSksXG4gICAgICBwdWJsaXNoTGFzdCgpLFxuICAgICAgcmVmQ291bnQoKVxuICAgICk7XG4gICAgb2JzLnN1YnNjcmliZSgpO1xuICAgIHJldHVybiBvYnM7XG4gIH1cblxuICBwdWJsaWMgZWxlbWVudHMob3B0aW9ucz86IEVsZW1lbnRzT3B0aW9ucyk6IE9ic2VydmFibGU8RWxlbWVudHM+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGVDaGFuZ2VkJC5waXBlKG1hcCgoKSA9PiB0aGlzLnN0cmlwZS5lbGVtZW50cyhvcHRpb25zKSkpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVRva2VuKFxuICAgIGE6IEVsZW1lbnQgfCBCYW5rQWNjb3VudCB8IFBpaSxcbiAgICBiOiBDYXJkRGF0YU9wdGlvbnMgfCBCYW5rQWNjb3VudERhdGEgfCBQaWlEYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8VG9rZW5SZXN1bHQ+IHtcbiAgICBpZiAoaXNCYW5rQWNjb3VudChhKSAmJiBpc0JhbmtBY2NvdW50RGF0YShiKSkge1xuICAgICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNyZWF0ZVRva2VuKGEsIGIpKTtcbiAgICB9IGVsc2UgaWYgKGlzUGlpKGEpICYmIGlzUGlpRGF0YShiKSkge1xuICAgICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNyZWF0ZVRva2VuKGEsIGIpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNyZWF0ZVRva2VuKGEgYXMgRWxlbWVudCwgYiBhcyBDYXJkRGF0YU9wdGlvbnMgfCB1bmRlZmluZWQpKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgcGF5bWVudFJlcXVlc3Qob3B0aW9uczogUmVxdWVzdEVsZW1lbnRPcHRpb25zKTogT2JzZXJ2YWJsZTxFbGVtZW50PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlQ2hhbmdlZCQucGlwZShtYXAoKCkgPT4gdGhpcy5zdHJpcGUucGF5bWVudFJlcXVlc3Qob3B0aW9ucykpKTtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVDYXJkU2V0dXAoXG4gICAgY2xpZW50U2VjcmV0OiBzdHJpbmcsXG4gICAgZWxlbWVudDogRWxlbWVudCxcbiAgICBjYXJkU2V0dXBPcHRpb25zPzogU2V0dXBJbnRlbnREYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8U2V0dXBJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuaGFuZGxlQ2FyZFNldHVwKGNsaWVudFNlY3JldCwgZWxlbWVudCwgY2FyZFNldHVwT3B0aW9ucykpO1xuICB9XG5cbiAgcHVibGljIGhhbmRsZUNhcmRQYXltZW50KFxuICAgIGNsaWVudFNlY3JldDogc3RyaW5nLFxuICAgIGVsZW1lbnQ6IEVsZW1lbnQsXG4gICAgY2FyZFNldHVwT3B0aW9ucz86IENhcmRQYXltZW50RGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFBheW1lbnRJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuaGFuZGxlQ2FyZFBheW1lbnQoY2xpZW50U2VjcmV0LCBlbGVtZW50LCBjYXJkU2V0dXBPcHRpb25zKSk7XG4gIH1cblxuICBwdWJsaWMgaGFuZGxlQ2FyZEFjdGlvbihjbGllbnRTZWNyZXQ6IHN0cmluZyk6IE9ic2VydmFibGU8UGF5bWVudEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5oYW5kbGVDYXJkQWN0aW9uKGNsaWVudFNlY3JldCkpO1xuICB9XG5cbiAgcHVibGljIGNvbmZpcm1QYXltZW50SW50ZW50KFxuICAgIGNsaWVudFNlY3JldDogc3RyaW5nLFxuICAgIGVsZW1lbnQ6IEVsZW1lbnQsXG4gICAgaW50ZW50T3B0aW9ucz86IENvbmZpcm1JbnRlbnREYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8U2V0dXBJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY29uZmlybVBheW1lbnRJbnRlbnQoY2xpZW50U2VjcmV0LCBlbGVtZW50LCBpbnRlbnRPcHRpb25zKSk7XG4gIH1cblxuICBwdWJsaWMgY29uZmlybUNhcmRQYXltZW50KFxuICAgIGNsaWVudFNlY3JldDogc3RyaW5nLFxuICAgIGRhdGE6IENvbmZpcm1DYXJkUGF5bWVudERhdGEsXG4gICAgb3B0aW9ucz86IENvbmZpcm1DYXJkUGF5bWVudE9wdGlvbnMgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxDb25maXJtQ2FyZFBheW1lbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY29uZmlybUNhcmRQYXltZW50KGNsaWVudFNlY3JldCwgZGF0YSwgb3B0aW9ucykpO1xuICB9XG5cbiAgcHVibGljIHJldHJpZXZlUGF5bWVudEludGVudChjbGllbnRTZWNyZXQ6IHN0cmluZyk6IE9ic2VydmFibGU8UGF5bWVudEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5yZXRyaWV2ZVBheW1lbnRJbnRlbnQoY2xpZW50U2VjcmV0KSk7XG4gIH1cblxuICBwdWJsaWMgcmV0cmlldmVTZXR1cEludGVudChjbGllbnRTZWNyZXQ6IHN0cmluZyk6IE9ic2VydmFibGU8U2V0dXBJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUucmV0cmlldmVTZXR1cEludGVudChjbGllbnRTZWNyZXQpKTtcbiAgfVxuXG4gIHB1YmxpYyBjb25maXJtU2V0dXBJbnRlbnQoXG4gICAgY2xpZW50U2VjcmV0OiBzdHJpbmcsXG4gICAgZWxlbWVudDogRWxlbWVudCxcbiAgICBpbnRlbnRPcHRpb25zPzogQ29uZmlybVNldHVwSW50ZW50RGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFNldHVwSW50ZW50UmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNvbmZpcm1TZXR1cEludGVudChjbGllbnRTZWNyZXQsIGVsZW1lbnQsIGludGVudE9wdGlvbnMpKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVTb3VyY2UoYTogRWxlbWVudCB8IFNvdXJjZURhdGEsIGI/OiBTb3VyY2VEYXRhIHwgdW5kZWZpbmVkKTogT2JzZXJ2YWJsZTxTb3VyY2VSZXN1bHQ+IHtcbiAgICBpZiAoaXNTb3VyY2VEYXRhKGEpKSB7XG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY3JlYXRlU291cmNlKGEgYXMgU291cmNlRGF0YSkpO1xuICAgIH1cbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY3JlYXRlU291cmNlKGEgYXMgRWxlbWVudCwgYikpO1xuICB9XG5cbiAgcHVibGljIHJldHJpZXZlU291cmNlKHNvdXJjZTogU291cmNlUGFyYW1zKTogT2JzZXJ2YWJsZTxTb3VyY2VSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUucmV0cmlldmVTb3VyY2Uoc291cmNlKSk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlUGF5bWVudE1ldGhvZChwYXltZW50TWV0aG9kOiBQYXltZW50TWV0aG9kUGFyYW1zKTogT2JzZXJ2YWJsZTxQYXltZW50TWV0aG9kUmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNyZWF0ZVBheW1lbnRNZXRob2QocGF5bWVudE1ldGhvZCkpO1xuICB9XG59XG4iXX0=