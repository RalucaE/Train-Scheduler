import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { BehaviorSubject, combineLatest, ReplaySubject, Subject } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { StripeService } from './services/stripe.service';
let PaymentRequestComponent = class PaymentRequestComponent {
    constructor(stripeService) {
        this.stripeService = stripeService;
        this.change = new EventEmitter();
        this.shippingAddressChange = new EventEmitter();
        this.shippingOptionChange = new EventEmitter();
        this.cancel = new EventEmitter();
        this.hide = false;
        this.styles$ = new BehaviorSubject({});
        this.options$ = new ReplaySubject();
        this.elementsOptions$ = new BehaviorSubject({});
        this.complete$ = new Subject();
        this._attached = false;
        this._opened = false;
    }
    set options(optionsIn) {
        this.options$.next(optionsIn);
    }
    set elementsOptions(optionsIn) {
        this.elementsOptions$.next(optionsIn);
    }
    set styles(optionsIn) {
        this.styles$.next(optionsIn);
    }
    set complete(success) {
        this.complete$.next(success);
    }
    ngOnInit() {
        this.elements$ = this.elementsOptions$.asObservable().pipe(switchMap(options => {
            return this.stripeService.elements(options);
        }));
        this.request$ = this.options$.asObservable().pipe(switchMap(options => {
            return this.stripeService.paymentRequest(options);
        }));
        this.complete$.subscribe(complete => {
            if (this.lastEvent) {
                if (complete) {
                    this.lastEvent.complete('success');
                }
                else {
                    this.lastEvent.complete('fail');
                }
            }
        });
    }
    ngAfterViewInit() {
        combineLatest(this.request$, this.elements$, this.options$, this.styles$).subscribe(([paymentRequest, elements, options, styles]) => {
            if (this.requestButton && !this._attached) {
                this._paymentRequest = paymentRequest;
                this._attached = true;
                const element = elements.create('paymentRequestButton', {
                    paymentRequest,
                    style: {
                        paymentRequestButton: Object.assign({}, styles)
                    }
                });
                this.hide = false;
                paymentRequest.canMakePayment().then(result => {
                    if (result) {
                        element.mount(this.requestButton.nativeElement);
                    }
                    else {
                        this.hide = true;
                    }
                });
                paymentRequest.on('shippingaddresschange', event => {
                    this.shippingAddressChange.emit(event);
                });
                paymentRequest.on('shippingoptionchange', event => {
                    this.shippingOptionChange.emit(event);
                });
                paymentRequest.on('token', event => {
                    this.change.emit(event);
                    this._opened = false;
                });
                paymentRequest.on('paymentmethod', event => {
                    this.change.emit(event);
                });
                paymentRequest.on('source', event => {
                    this.change.emit(event);
                });
                paymentRequest.on('cancel', event => {
                    this.cancel.emit(event);
                    this._opened = false;
                });
                paymentRequest.on('click', () => {
                    this._opened = true;
                });
            }
            else if (this._attached && !this._opened) {
                this._paymentRequest.update({
                    currency: options.currency,
                    total: options.total,
                    displayItems: options.displayItems,
                    shippingOptions: options.shippingOptions
                });
            }
        });
    }
};
PaymentRequestComponent.ctorParameters = () => [
    { type: StripeService }
];
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object),
    tslib_1.__metadata("design:paramtypes", [Object])
], PaymentRequestComponent.prototype, "options", null);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object),
    tslib_1.__metadata("design:paramtypes", [Object])
], PaymentRequestComponent.prototype, "elementsOptions", null);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object),
    tslib_1.__metadata("design:paramtypes", [Object])
], PaymentRequestComponent.prototype, "styles", null);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean),
    tslib_1.__metadata("design:paramtypes", [Boolean])
], PaymentRequestComponent.prototype, "complete", null);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], PaymentRequestComponent.prototype, "change", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], PaymentRequestComponent.prototype, "shippingAddressChange", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], PaymentRequestComponent.prototype, "shippingOptionChange", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", Object)
], PaymentRequestComponent.prototype, "cancel", void 0);
tslib_1.__decorate([
    ViewChild('request', { static: false }),
    tslib_1.__metadata("design:type", ElementRef)
], PaymentRequestComponent.prototype, "requestButton", void 0);
PaymentRequestComponent = tslib_1.__decorate([
    Component({
        selector: 'ngx-payment-request',
        template: '<div #request [style.display-none]="hide"></div>'
    }),
    tslib_1.__metadata("design:paramtypes", [StripeService])
], PaymentRequestComponent);
export { PaymentRequestComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudC1yZXF1ZXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bub21hZHJlc2VydmF0aW9ucy9uZ3gtc3RyaXBlL3Byb2plY3RzL25neC1zdHJpcGUvIiwic291cmNlcyI6WyJsaWIvcGF5bWVudC1yZXF1ZXN0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFpQixTQUFTLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNySCxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBYyxhQUFhLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUszQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFNMUQsSUFBYSx1QkFBdUIsR0FBcEMsTUFBYSx1QkFBdUI7SUFxQmxDLFlBQW9CLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQy9CLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFtQnRDLENBQUM7UUFDWSwwQkFBcUIsR0FBRyxJQUFJLFlBQVksRUFHckQsQ0FBQztRQUNZLHlCQUFvQixHQUFHLElBQUksWUFBWSxFQUdwRCxDQUFDO1FBQ1ksV0FBTSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFFM0MsU0FBSSxHQUFHLEtBQUssQ0FBQztRQUdaLFlBQU8sR0FBRyxJQUFJLGVBQWUsQ0FBNEIsRUFBRSxDQUFDLENBQUM7UUFDN0QsYUFBUSxHQUFHLElBQUksYUFBYSxFQUF5QixDQUFDO1FBQ3RELHFCQUFnQixHQUFHLElBQUksZUFBZSxDQUFrQixFQUFFLENBQUMsQ0FBQztRQUU1RCxjQUFTLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQUNuQyxjQUFTLEdBQUcsS0FBSyxDQUFDO1FBQ2xCLFlB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LE9BQU8sRUFBRTtnQkFDMUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUM7b0JBQzFCLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtvQkFDMUIsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLO29CQUNwQixZQUFZLEVBQUUsT0FBTyxDQUFDLFlBQVk7b0JBQ2xDLGVBQWUsRUFBRSxPQUFPLENBQUMsZUFBZTtpQkFDekMsQ0FBQyxDQUFDO2FBQ0o7UUFDSCxDQUFDLENBQ0YsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFBOztZQTNIb0MsYUFBYTs7QUFuQmhEO0lBREMsS0FBSyxFQUFFOzs7c0RBR1A7QUFHRDtJQURDLEtBQUssRUFBRTs7OzhEQUdQO0FBR0Q7SUFEQyxLQUFLLEVBQUU7OztxREFHUDtBQUdEO0lBREMsS0FBSyxFQUFFOzs7dURBR1A7QUFHUztJQUFULE1BQU0sRUFBRTs7dURBbUJKO0FBQ0s7SUFBVCxNQUFNLEVBQUU7O3NFQUdKO0FBQ0s7SUFBVCxNQUFNLEVBQUU7O3FFQUdKO0FBQ0s7SUFBVCxNQUFNLEVBQUU7O3VEQUF5QztBQUlUO0lBQXhDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7c0NBQXlCLFVBQVU7OERBQUM7QUF0RGpFLHVCQUF1QjtJQUpuQyxTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUscUJBQXFCO1FBQy9CLFFBQVEsRUFBRSxrREFBa0Q7S0FDN0QsQ0FBQzs2Q0FzQm1DLGFBQWE7R0FyQnJDLHVCQUF1QixDQWdKbkM7U0FoSlksdUJBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkluaXQsIE91dHB1dCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUsIFJlcGxheVN1YmplY3QsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFBheW1lbnRSZXF1ZXN0QnV0dG9uU3R5bGUsIFJlcXVlc3RFbGVtZW50T3B0aW9ucywgVXBkYXRlRGV0YWlscyB9IGZyb20gJy4vaW50ZXJmYWNlcy9lbGVtZW50JztcbmltcG9ydCB7IEVsZW1lbnRzT3B0aW9ucyB9IGZyb20gJy4vaW50ZXJmYWNlcy9lbGVtZW50cyc7XG5pbXBvcnQgeyBTb3VyY2UgfSBmcm9tICcuL2ludGVyZmFjZXMvc291cmNlcyc7XG5pbXBvcnQgeyBTaGlwcGluZ0FkZHJlc3MsIFNoaXBwaW5nT3B0aW9ucywgVG9rZW4gfSBmcm9tICcuL2ludGVyZmFjZXMvdG9rZW4nO1xuaW1wb3J0IHsgU3RyaXBlU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvc3RyaXBlLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3gtcGF5bWVudC1yZXF1ZXN0JyxcbiAgdGVtcGxhdGU6ICc8ZGl2ICNyZXF1ZXN0IFtzdHlsZS5kaXNwbGF5LW5vbmVdPVwiaGlkZVwiPjwvZGl2Pidcbn0pXG5leHBvcnQgY2xhc3MgUGF5bWVudFJlcXVlc3RDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQge1xuICBASW5wdXQoKVxuICBwcml2YXRlIHNldCBvcHRpb25zKG9wdGlvbnNJbjogUmVxdWVzdEVsZW1lbnRPcHRpb25zKSB7XG4gICAgdGhpcy5vcHRpb25zJC5uZXh0KG9wdGlvbnNJbik7XG4gIH1cblxuICBASW5wdXQoKVxuICBwdWJsaWMgc2V0IGVsZW1lbnRzT3B0aW9ucyhvcHRpb25zSW46IEVsZW1lbnRzT3B0aW9ucykge1xuICAgIHRoaXMuZWxlbWVudHNPcHRpb25zJC5uZXh0KG9wdGlvbnNJbik7XG4gIH1cblxuICBASW5wdXQoKVxuICBwdWJsaWMgc2V0IHN0eWxlcyhvcHRpb25zSW46IFBheW1lbnRSZXF1ZXN0QnV0dG9uU3R5bGUpIHtcbiAgICB0aGlzLnN0eWxlcyQubmV4dChvcHRpb25zSW4pO1xuICB9XG5cbiAgQElucHV0KClcbiAgcHVibGljIHNldCBjb21wbGV0ZShzdWNjZXNzOiBib29sZWFuKSB7XG4gICAgdGhpcy5jb21wbGV0ZSQubmV4dChzdWNjZXNzKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgc3RyaXBlU2VydmljZTogU3RyaXBlU2VydmljZSkge31cbiAgQE91dHB1dCgpIHB1YmxpYyBjaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPHtcbiAgICB0b2tlbj86IFRva2VuO1xuICAgIHBheW1lbnRNZXRob2Q/OiBQYXltZW50TWV0aG9kRGF0YTtcbiAgICBzb3VyY2U/OiBTb3VyY2U7XG4gICAgY29tcGxldGU6IChcbiAgICAgIHN0YXR1czpcbiAgICAgICAgfCAnc3VjY2VzcydcbiAgICAgICAgfCAnZmFpbCdcbiAgICAgICAgfCAnaW52YWxpZF9wYXllcl9uYW1lJ1xuICAgICAgICB8ICdpbnZhbGlkX3BheWVyX3Bob25lJ1xuICAgICAgICB8ICdpbnZhbGlkX3BheWVyX2VtYWlsJ1xuICAgICAgICB8ICdpbnZhbGlkX3NoaXBwaW5nX2FkZHJlc3MnXG4gICAgKSA9PiB7fTtcbiAgICBwYXllck5hbWU/OiBzdHJpbmc7XG4gICAgcGF5ZXJFbWFpbD86IHN0cmluZztcbiAgICBwYXllclBob25lPzogc3RyaW5nO1xuICAgIHNoaXBwaW5nQWRkcmVzcz86IFNoaXBwaW5nQWRkcmVzcztcbiAgICBzaGlwcGluZ09wdGlvbj86IFNoaXBwaW5nT3B0aW9ucztcbiAgICBtZXRob2ROYW1lPzogc3RyaW5nO1xuICB9PigpO1xuICBAT3V0cHV0KCkgcHVibGljIHNoaXBwaW5nQWRkcmVzc0NoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8e1xuICAgIHVwZGF0ZVdpdGg6ICh1cGRhdGVEZXRhaWxzOiBVcGRhdGVEZXRhaWxzKSA9PiB7fTtcbiAgICBzaGlwcGluZ0FkZHJlc3M6IFNoaXBwaW5nQWRkcmVzcztcbiAgfT4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBzaGlwcGluZ09wdGlvbkNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8e1xuICAgIHVwZGF0ZVdpdGg6ICh1cGRhdGVEZXRhaWxzOiBVcGRhdGVEZXRhaWxzKSA9PiB7fTtcbiAgICBzaGlwcGluZ09wdGlvbjogU2hpcHBpbmdPcHRpb25zO1xuICB9PigpO1xuICBAT3V0cHV0KCkgcHVibGljIGNhbmNlbCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIHB1YmxpYyBoaWRlID0gZmFsc2U7XG5cbiAgQFZpZXdDaGlsZCgncmVxdWVzdCcsIHsgc3RhdGljOiBmYWxzZSB9KSBwcml2YXRlIHJlcXVlc3RCdXR0b24/OiBFbGVtZW50UmVmO1xuICBwcml2YXRlIHN0eWxlcyQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFBheW1lbnRSZXF1ZXN0QnV0dG9uU3R5bGU+KHt9KTtcbiAgcHJpdmF0ZSBvcHRpb25zJCA9IG5ldyBSZXBsYXlTdWJqZWN0PFJlcXVlc3RFbGVtZW50T3B0aW9ucz4oKTtcbiAgcHJpdmF0ZSBlbGVtZW50c09wdGlvbnMkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxFbGVtZW50c09wdGlvbnM+KHt9KTtcbiAgcHJpdmF0ZSBsYXN0RXZlbnQ6IGFueTtcbiAgcHJpdmF0ZSBjb21wbGV0ZSQgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuICBwcml2YXRlIF9hdHRhY2hlZCA9IGZhbHNlO1xuICBwcml2YXRlIF9vcGVuZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBfcGF5bWVudFJlcXVlc3Q6IGFueTtcblxuICBwcml2YXRlIGVsZW1lbnRzJDogT2JzZXJ2YWJsZTxhbnk+O1xuICBwcml2YXRlIHJlcXVlc3QkOiBPYnNlcnZhYmxlPGFueT47XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5lbGVtZW50cyQgPSB0aGlzLmVsZW1lbnRzT3B0aW9ucyQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIHN3aXRjaE1hcChvcHRpb25zID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RyaXBlU2VydmljZS5lbGVtZW50cyhvcHRpb25zKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgICB0aGlzLnJlcXVlc3QkID0gdGhpcy5vcHRpb25zJC5hc09ic2VydmFibGUoKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKG9wdGlvbnMgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdHJpcGVTZXJ2aWNlLnBheW1lbnRSZXF1ZXN0KG9wdGlvbnMpO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgdGhpcy5jb21wbGV0ZSQuc3Vic2NyaWJlKGNvbXBsZXRlID0+IHtcbiAgICAgIGlmICh0aGlzLmxhc3RFdmVudCkge1xuICAgICAgICBpZiAoY29tcGxldGUpIHtcbiAgICAgICAgICB0aGlzLmxhc3RFdmVudC5jb21wbGV0ZSgnc3VjY2VzcycpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubGFzdEV2ZW50LmNvbXBsZXRlKCdmYWlsJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgY29tYmluZUxhdGVzdCh0aGlzLnJlcXVlc3QkLCB0aGlzLmVsZW1lbnRzJCwgdGhpcy5vcHRpb25zJCwgdGhpcy5zdHlsZXMkKS5zdWJzY3JpYmUoXG4gICAgICAoW3BheW1lbnRSZXF1ZXN0LCBlbGVtZW50cywgb3B0aW9ucywgc3R5bGVzXSkgPT4ge1xuICAgICAgICBpZiAodGhpcy5yZXF1ZXN0QnV0dG9uICYmICF0aGlzLl9hdHRhY2hlZCkge1xuICAgICAgICAgIHRoaXMuX3BheW1lbnRSZXF1ZXN0ID0gcGF5bWVudFJlcXVlc3Q7XG4gICAgICAgICAgdGhpcy5fYXR0YWNoZWQgPSB0cnVlO1xuICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBlbGVtZW50cy5jcmVhdGUoJ3BheW1lbnRSZXF1ZXN0QnV0dG9uJywge1xuICAgICAgICAgICAgcGF5bWVudFJlcXVlc3QsXG4gICAgICAgICAgICBzdHlsZToge1xuICAgICAgICAgICAgICBwYXltZW50UmVxdWVzdEJ1dHRvbjogeyAuLi5zdHlsZXMgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgdGhpcy5oaWRlID0gZmFsc2U7XG4gICAgICAgICAgcGF5bWVudFJlcXVlc3QuY2FuTWFrZVBheW1lbnQoKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgIGVsZW1lbnQubW91bnQodGhpcy5yZXF1ZXN0QnV0dG9uLm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5oaWRlID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwYXltZW50UmVxdWVzdC5vbignc2hpcHBpbmdhZGRyZXNzY2hhbmdlJywgZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy5zaGlwcGluZ0FkZHJlc3NDaGFuZ2UuZW1pdChldmVudCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcGF5bWVudFJlcXVlc3Qub24oJ3NoaXBwaW5nb3B0aW9uY2hhbmdlJywgZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy5zaGlwcGluZ09wdGlvbkNoYW5nZS5lbWl0KGV2ZW50KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwYXltZW50UmVxdWVzdC5vbigndG9rZW4nLCBldmVudCA9PiB7XG4gICAgICAgICAgICB0aGlzLmNoYW5nZS5lbWl0KGV2ZW50KTtcbiAgICAgICAgICAgIHRoaXMuX29wZW5lZCA9IGZhbHNlO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHBheW1lbnRSZXF1ZXN0Lm9uKCdwYXltZW50bWV0aG9kJywgZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy5jaGFuZ2UuZW1pdChldmVudCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcGF5bWVudFJlcXVlc3Qub24oJ3NvdXJjZScsIGV2ZW50ID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlLmVtaXQoZXZlbnQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHBheW1lbnRSZXF1ZXN0Lm9uKCdjYW5jZWwnLCBldmVudCA9PiB7XG4gICAgICAgICAgICB0aGlzLmNhbmNlbC5lbWl0KGV2ZW50KTtcbiAgICAgICAgICAgIHRoaXMuX29wZW5lZCA9IGZhbHNlO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHBheW1lbnRSZXF1ZXN0Lm9uKCdjbGljaycsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX29wZW5lZCA9IHRydWU7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5fYXR0YWNoZWQgJiYgIXRoaXMuX29wZW5lZCkge1xuICAgICAgICAgIHRoaXMuX3BheW1lbnRSZXF1ZXN0LnVwZGF0ZSh7XG4gICAgICAgICAgICBjdXJyZW5jeTogb3B0aW9ucy5jdXJyZW5jeSxcbiAgICAgICAgICAgIHRvdGFsOiBvcHRpb25zLnRvdGFsLFxuICAgICAgICAgICAgZGlzcGxheUl0ZW1zOiBvcHRpb25zLmRpc3BsYXlJdGVtcyxcbiAgICAgICAgICAgIHNoaXBwaW5nT3B0aW9uczogb3B0aW9ucy5zaGlwcGluZ09wdGlvbnNcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG4gIH1cbn1cbiJdfQ==