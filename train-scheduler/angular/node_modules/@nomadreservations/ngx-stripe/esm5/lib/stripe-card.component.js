import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { BehaviorSubject, combineLatest as observableCombineLatest } from 'rxjs';
import { filter, switchMap } from 'rxjs/operators';
import { StripeService } from './services/stripe.service';
var StripeCardComponent = /** @class */ (function () {
    function StripeCardComponent(stripeService) {
        this.stripeService = stripeService;
        this.change = new EventEmitter();
        this.complete = new EventEmitter();
        this.error = new EventEmitter();
        this.elementTypes = ['card'];
        this.options$ = new BehaviorSubject({});
        this.elementsOptions$ = new BehaviorSubject({});
    }
    Object.defineProperty(StripeCardComponent.prototype, "options", {
        set: function (optionsIn) {
            this.options$.next(optionsIn);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StripeCardComponent.prototype, "elementsOptions", {
        set: function (optionsIn) {
            this.elementsOptions$.next(optionsIn);
        },
        enumerable: true,
        configurable: true
    });
    StripeCardComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        var elements$ = this.elementsOptions$.asObservable().pipe(switchMap(function (options) {
            if (Object.keys(options).length > 0) {
                return _this.stripeService.elements(options);
            }
            return _this.stripeService.elements();
        }));
        var complete = {};
        observableCombineLatest(elements$, this.options$.asObservable().pipe(filter(function (options) { return Boolean(options); }))).subscribe(function (_a) {
            var e_1, _b;
            var _c = tslib_1.__read(_a, 2), elements = _c[0], options = _c[1];
            _this.elements = [];
            if (_this.card) {
                var _loop_1 = function (type) {
                    var _a;
                    var element = elements.create(type, options);
                    complete = tslib_1.__assign({}, complete, (_a = {}, _a[type] = element, _a));
                    if (['card', 'cardNumber'].indexOf(type) !== -1) {
                        _this.cardElement = element;
                    }
                    var mountTo = _this.card.nativeElement.querySelector("." + type);
                    element.mount(mountTo);
                    element.on('change', function (changedCard) {
                        var isComplete = changedCard.complete;
                        for (var key in complete) {
                            if (complete) {
                                var value = complete[key];
                                if (key !== changedCard.elementType && !value._complete) {
                                    isComplete = false;
                                }
                            }
                        }
                        _this.change.emit({
                            card: changedCard,
                            elements: _this.elements,
                            type: changedCard.elementType,
                            complete: isComplete,
                            element: element
                        });
                        if (isComplete) {
                            _this.complete.emit({
                                card: changedCard,
                                elements: _this.elements,
                                type: changedCard.elementType,
                                complete: isComplete,
                                element: element
                            });
                        }
                        if (changedCard.error) {
                            _this.error.emit(changedCard.error);
                        }
                    });
                    _this.elements = tslib_1.__spread(_this.elements, [element]);
                };
                try {
                    for (var _d = tslib_1.__values(_this.elementTypes), _e = _d.next(); !_e.done; _e = _d.next()) {
                        var type = _e.value;
                        _loop_1(type);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (_e && !_e.done && (_b = _d.return)) _b.call(_d);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
            }
        });
    };
    StripeCardComponent.prototype.getCard = function () {
        return this.cardElement;
    };
    StripeCardComponent.ctorParameters = function () { return [
        { type: StripeService }
    ]; };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], StripeCardComponent.prototype, "options", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], StripeCardComponent.prototype, "elementsOptions", null);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], StripeCardComponent.prototype, "change", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], StripeCardComponent.prototype, "complete", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], StripeCardComponent.prototype, "error", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Array)
    ], StripeCardComponent.prototype, "elementTypes", void 0);
    tslib_1.__decorate([
        ViewChild('card', { static: false }),
        tslib_1.__metadata("design:type", ElementRef)
    ], StripeCardComponent.prototype, "card", void 0);
    StripeCardComponent = tslib_1.__decorate([
        Component({
            selector: 'ngx-stripe-card',
            template: "\n    <div class=\"field\" #card>\n      <div [class]=\"type\" *ngFor=\"let type of elementTypes\"></div>\n    </div>\n  "
        }),
        tslib_1.__metadata("design:paramtypes", [StripeService])
    ], StripeCardComponent);
    return StripeCardComponent;
}());
export { StripeCardComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLWNhcmQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5vbWFkcmVzZXJ2YXRpb25zL25neC1zdHJpcGUvIiwic291cmNlcyI6WyJsaWIvc3RyaXBlLWNhcmQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQWlCLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdHLE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxJQUFJLHVCQUF1QixFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQzdGLE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBVTFEO0lBV0UsNkJBQW9CLGFBQTRCO1FBQTVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQy9CLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBeUMsQ0FBQztRQUNuRSxhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQXlDLENBQUM7UUFDckUsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFDakMsaUJBQVksR0FBdUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUtwRCxhQUFRLEdBQUcsSUFBSSxlQUFlLENBQWlCLEVBQUUsQ0FBQyxDQUFDO1FBQ25ELHFCQUFnQixHQUFHLElBQUksZUFBZSxDQUFrQixFQUFFLENBQUMsQ0FBQztJQVZqQixDQUFDO0lBVHBELHNCQUFZLHdDQUFPO2FBQW5CLFVBQW9CLFNBQXlCO1lBQzNDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2hDLENBQUM7OztPQUFBO0lBR0Qsc0JBQVcsZ0RBQWU7YUFBMUIsVUFBMkIsU0FBMEI7WUFDbkQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxT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SSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQzt5QkFDcEM7b0JBQ0gsQ0FBQyxDQUFDLENBQUM7b0JBQ0gsS0FBSSxDQUFDLFFBQVEsb0JBQU8sS0FBSSxDQUFDLFFBQVEsR0FBRSxPQUFPLEVBQUMsQ0FBQzs7O29CQTVDOUMsS0FBbUIsSUFBQSxLQUFBLGlCQUFBLEtBQUksQ0FBQyxZQUFZLENBQUEsZ0JBQUE7d0JBQS9CLElBQU0sSUFBSSxXQUFBO2dDQUFKLElBQUk7cUJBNkNkOzs7Ozs7Ozs7YUFDRjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLHFDQUFPLEdBQWQ7UUFDRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDMUIsQ0FBQzs7Z0JBaEZrQyxhQUFhOztJQVRoRDtRQURDLEtBQUssRUFBRTs7O3NEQUdQO0lBR0Q7UUFEQyxLQUFLLEVBQUU7Ozs4REFHUDtJQUdTO1FBQVQsTUFBTSxFQUFFOzt1REFBMkU7SUFDMUU7UUFBVCxNQUFNLEVBQUU7O3lEQUE2RTtJQUM1RTtRQUFULE1BQU0sRUFBRTs7c0RBQXdDO0lBQ3hDO1FBQVIsS0FBSyxFQUFFOzBDQUFzQixLQUFLOzZEQUF5QjtJQUV0QjtRQUFyQyxTQUFTLENBQUMsTUFBTSxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDOzBDQUFlLFVBQVU7cURBQUM7SUFqQnBELG1CQUFtQjtRQVIvQixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsaUJBQWlCO1lBQzNCLFFBQVEsRUFBRSwySEFJVDtTQUNGLENBQUM7aURBWW1DLGFBQWE7T0FYckMsbUJBQW1CLENBNEYvQjtJQUFELDBCQUFDO0NBQUEsQUE1RkQsSUE0RkM7U0E1RlksbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPdXRwdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0IGFzIG9ic2VydmFibGVDb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEVsZW1lbnQgYXMgU3RyaXBlRWxlbWVudCwgRWxlbWVudE9wdGlvbnMsIEVsZW1lbnRUeXBlIH0gZnJvbSAnLi9pbnRlcmZhY2VzL2VsZW1lbnQnO1xuaW1wb3J0IHsgRWxlbWVudHMsIEVsZW1lbnRzT3B0aW9ucyB9IGZyb20gJy4vaW50ZXJmYWNlcy9lbGVtZW50cyc7XG5pbXBvcnQgeyBTdHJpcGVTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9zdHJpcGUuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25neC1zdHJpcGUtY2FyZCcsXG4gIHRlbXBsYXRlOiBgXG4gICAgPGRpdiBjbGFzcz1cImZpZWxkXCIgI2NhcmQ+XG4gICAgICA8ZGl2IFtjbGFzc109XCJ0eXBlXCIgKm5nRm9yPVwibGV0IHR5cGUgb2YgZWxlbWVudFR5cGVzXCI+PC9kaXY+XG4gICAgPC9kaXY+XG4gIGBcbn0pXG5leHBvcnQgY2xhc3MgU3RyaXBlQ2FyZENvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQge1xuICBASW5wdXQoKVxuICBwcml2YXRlIHNldCBvcHRpb25zKG9wdGlvbnNJbjogRWxlbWVudE9wdGlvbnMpIHtcbiAgICB0aGlzLm9wdGlvbnMkLm5leHQob3B0aW9uc0luKTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBzZXQgZWxlbWVudHNPcHRpb25zKG9wdGlvbnNJbjogRWxlbWVudHNPcHRpb25zKSB7XG4gICAgdGhpcy5lbGVtZW50c09wdGlvbnMkLm5leHQob3B0aW9uc0luKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgc3RyaXBlU2VydmljZTogU3RyaXBlU2VydmljZSkge31cbiAgQE91dHB1dCgpIHB1YmxpYyBjaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPHsgY2FyZDogYW55OyBlbGVtZW50OiBTdHJpcGVFbGVtZW50IH0+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgY29tcGxldGUgPSBuZXcgRXZlbnRFbWl0dGVyPHsgY2FyZDogYW55OyBlbGVtZW50OiBTdHJpcGVFbGVtZW50IH0+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgZXJyb3IgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQElucHV0KCkgcHVibGljIGVsZW1lbnRUeXBlczogQXJyYXk8RWxlbWVudFR5cGU+ID0gWydjYXJkJ107XG5cbiAgQFZpZXdDaGlsZCgnY2FyZCcsIHsgc3RhdGljOiBmYWxzZSB9KSBwcml2YXRlIGNhcmQ6IEVsZW1lbnRSZWY7XG4gIHByaXZhdGUgY2FyZEVsZW1lbnQ/OiBTdHJpcGVFbGVtZW50O1xuICBwcml2YXRlIGVsZW1lbnRzPzogQXJyYXk8U3RyaXBlRWxlbWVudD47XG4gIHByaXZhdGUgb3B0aW9ucyQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEVsZW1lbnRPcHRpb25zPih7fSk7XG4gIHByaXZhdGUgZWxlbWVudHNPcHRpb25zJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RWxlbWVudHNPcHRpb25zPih7fSk7XG5cbiAgcHVibGljIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICBjb25zdCBlbGVtZW50cyQ6IE9ic2VydmFibGU8RWxlbWVudHM+ID0gdGhpcy5lbGVtZW50c09wdGlvbnMkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAob3B0aW9ucyA9PiB7XG4gICAgICAgIGlmIChPYmplY3Qua2V5cyhvcHRpb25zKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc3RyaXBlU2VydmljZS5lbGVtZW50cyhvcHRpb25zKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zdHJpcGVTZXJ2aWNlLmVsZW1lbnRzKCk7XG4gICAgICB9KVxuICAgICk7XG4gICAgbGV0IGNvbXBsZXRlID0ge307XG4gICAgb2JzZXJ2YWJsZUNvbWJpbmVMYXRlc3QoXG4gICAgICBlbGVtZW50cyQsXG4gICAgICB0aGlzLm9wdGlvbnMkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoZmlsdGVyKG9wdGlvbnMgPT4gQm9vbGVhbihvcHRpb25zKSkpXG4gICAgKS5zdWJzY3JpYmUoKFtlbGVtZW50cywgb3B0aW9uc10pID0+IHtcbiAgICAgIHRoaXMuZWxlbWVudHMgPSBbXTtcbiAgICAgIGlmICh0aGlzLmNhcmQpIHtcbiAgICAgICAgZm9yIChjb25zdCB0eXBlIG9mIHRoaXMuZWxlbWVudFR5cGVzKSB7XG4gICAgICAgICAgY29uc3QgZWxlbWVudCA9IGVsZW1lbnRzLmNyZWF0ZSh0eXBlLCBvcHRpb25zKTtcbiAgICAgICAgICBjb21wbGV0ZSA9IHtcbiAgICAgICAgICAgIC4uLmNvbXBsZXRlLFxuICAgICAgICAgICAgW3R5cGVdOiBlbGVtZW50XG4gICAgICAgICAgfTtcblxuICAgICAgICAgIGlmIChbJ2NhcmQnLCAnY2FyZE51bWJlciddLmluZGV4T2YodHlwZSkgIT09IC0xKSB7XG4gICAgICAgICAgICB0aGlzLmNhcmRFbGVtZW50ID0gZWxlbWVudDtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgbW91bnRUbyA9IHRoaXMuY2FyZC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoYC4ke3R5cGV9YCk7XG5cbiAgICAgICAgICBlbGVtZW50Lm1vdW50KG1vdW50VG8pO1xuXG4gICAgICAgICAgZWxlbWVudC5vbignY2hhbmdlJywgY2hhbmdlZENhcmQgPT4ge1xuICAgICAgICAgICAgbGV0IGlzQ29tcGxldGUgPSBjaGFuZ2VkQ2FyZC5jb21wbGV0ZTtcbiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgIGlmIChjb21wbGV0ZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gY29tcGxldGVba2V5XTtcbiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBjaGFuZ2VkQ2FyZC5lbGVtZW50VHlwZSAmJiAhdmFsdWUuX2NvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgICBpc0NvbXBsZXRlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmNoYW5nZS5lbWl0KHtcbiAgICAgICAgICAgICAgY2FyZDogY2hhbmdlZENhcmQsXG4gICAgICAgICAgICAgIGVsZW1lbnRzOiB0aGlzLmVsZW1lbnRzLFxuICAgICAgICAgICAgICB0eXBlOiBjaGFuZ2VkQ2FyZC5lbGVtZW50VHlwZSxcbiAgICAgICAgICAgICAgY29tcGxldGU6IGlzQ29tcGxldGUsXG4gICAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnRcbiAgICAgICAgICAgIH0gYXMgYW55KTtcbiAgICAgICAgICAgIGlmIChpc0NvbXBsZXRlKSB7XG4gICAgICAgICAgICAgIHRoaXMuY29tcGxldGUuZW1pdCh7XG4gICAgICAgICAgICAgICAgY2FyZDogY2hhbmdlZENhcmQsXG4gICAgICAgICAgICAgICAgZWxlbWVudHM6IHRoaXMuZWxlbWVudHMsXG4gICAgICAgICAgICAgICAgdHlwZTogY2hhbmdlZENhcmQuZWxlbWVudFR5cGUsXG4gICAgICAgICAgICAgICAgY29tcGxldGU6IGlzQ29tcGxldGUsXG4gICAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudFxuICAgICAgICAgICAgICB9IGFzIGFueSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY2hhbmdlZENhcmQuZXJyb3IpIHtcbiAgICAgICAgICAgICAgdGhpcy5lcnJvci5lbWl0KGNoYW5nZWRDYXJkLmVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aGlzLmVsZW1lbnRzID0gWy4uLnRoaXMuZWxlbWVudHMsIGVsZW1lbnRdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0Q2FyZCgpOiBTdHJpcGVFbGVtZW50IHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5jYXJkRWxlbWVudDtcbiAgfVxufVxuIl19