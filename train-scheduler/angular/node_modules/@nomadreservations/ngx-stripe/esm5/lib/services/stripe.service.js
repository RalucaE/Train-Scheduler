import * as tslib_1 from "tslib";
import { Inject, Injectable } from '@angular/core';
import { from as observableFrom, ReplaySubject } from 'rxjs';
import { filter, map, publishLast, refCount, take } from 'rxjs/operators';
import { isSourceData } from '../interfaces/sources';
import { STRIPE_OPTIONS, STRIPE_PUBLISHABLE_KEY } from '../interfaces/stripe';
import { isBankAccount, isBankAccountData, isPii, isPiiData } from '../interfaces/token';
import { LazyStripeAPILoader, Status } from './api-loader.service';
import { PlatformService } from './platform.service';
import { WindowRef } from './window-ref.service';
var StripeService = /** @class */ (function () {
    function StripeService(key, options, loader, window, _platform) {
        this.key = key;
        this.options = options;
        this.loader = loader;
        this.window = window;
        this._platform = _platform;
        this.stripeChanged$ = new ReplaySubject();
        this.stripe = {};
        this.changeKey(this.key, this.options)
            .pipe(take(1))
            .subscribe(function () { });
    }
    StripeService.prototype.changeKey = function (key, options) {
        var _this = this;
        var obs = this.loader.asStream().pipe(filter(function (status) { return status.loaded === true; }), map(function () {
            if (!_this.window.getNativeWindow()) {
                return;
            }
            var Stripe = _this.window.getNativeWindow().Stripe;
            if (key) {
                _this.stripe = options ? Stripe(key, options) : Stripe(key);
                _this.stripeChanged$.next(_this.stripe);
            }
            return _this.stripe;
        }), publishLast(), refCount());
        obs.subscribe();
        return obs;
    };
    StripeService.prototype.elements = function (options) {
        var _this = this;
        return this.stripeChanged$.pipe(map(function () { return _this.stripe.elements(options); }));
    };
    StripeService.prototype.createToken = function (a, b) {
        if (isBankAccount(a) && isBankAccountData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else if (isPii(a) && isPiiData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else {
            return observableFrom(this.stripe.createToken(a, b));
        }
    };
    StripeService.prototype.paymentRequest = function (options) {
        var _this = this;
        return this.stripeChanged$.pipe(map(function () { return _this.stripe.paymentRequest(options); }));
    };
    StripeService.prototype.handleCardSetup = function (clientSecret, element, cardSetupOptions) {
        return observableFrom(this.stripe.handleCardSetup(clientSecret, element, cardSetupOptions));
    };
    StripeService.prototype.handleCardPayment = function (clientSecret, element, cardSetupOptions) {
        return observableFrom(this.stripe.handleCardPayment(clientSecret, element, cardSetupOptions));
    };
    StripeService.prototype.handleCardAction = function (clientSecret) {
        return observableFrom(this.stripe.handleCardAction(clientSecret));
    };
    StripeService.prototype.confirmPaymentIntent = function (clientSecret, element, intentOptions) {
        return observableFrom(this.stripe.confirmPaymentIntent(clientSecret, element, intentOptions));
    };
    StripeService.prototype.confirmCardPayment = function (clientSecret, data, options) {
        return observableFrom(this.stripe.confirmCardPayment(clientSecret, data, options));
    };
    StripeService.prototype.retrievePaymentIntent = function (clientSecret) {
        return observableFrom(this.stripe.retrievePaymentIntent(clientSecret));
    };
    StripeService.prototype.retrieveSetupIntent = function (clientSecret) {
        return observableFrom(this.stripe.retrieveSetupIntent(clientSecret));
    };
    StripeService.prototype.confirmSetupIntent = function (clientSecret, element, intentOptions) {
        return observableFrom(this.stripe.confirmSetupIntent(clientSecret, element, intentOptions));
    };
    StripeService.prototype.createSource = function (a, b) {
        if (isSourceData(a)) {
            return observableFrom(this.stripe.createSource(a));
        }
        return observableFrom(this.stripe.createSource(a, b));
    };
    StripeService.prototype.retrieveSource = function (source) {
        return observableFrom(this.stripe.retrieveSource(source));
    };
    StripeService.prototype.createPaymentMethod = function (paymentMethod) {
        return observableFrom(this.stripe.createPaymentMethod(paymentMethod));
    };
    StripeService.ctorParameters = function () { return [
        { type: String, decorators: [{ type: Inject, args: [STRIPE_PUBLISHABLE_KEY,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [STRIPE_OPTIONS,] }] },
        { type: LazyStripeAPILoader },
        { type: WindowRef },
        { type: PlatformService }
    ]; };
    StripeService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(0, Inject(STRIPE_PUBLISHABLE_KEY)),
        tslib_1.__param(1, Inject(STRIPE_OPTIONS)),
        tslib_1.__metadata("design:paramtypes", [String, Object, LazyStripeAPILoader,
            WindowRef,
            PlatformService])
    ], StripeService);
    return StripeService;
}());
export { StripeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abm9tYWRyZXNlcnZhdGlvbnMvbmd4LXN0cmlwZS8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9zdHJpcGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBR0EsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLElBQUksSUFBSSxjQUFjLEVBQWMsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHMUUsT0FBTyxFQUFFLFlBQVksRUFBMEMsTUFBTSx1QkFBdUIsQ0FBQztBQUM3RixPQUFPLEVBQXFCLGNBQWMsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2pHLE9BQU8sRUFVTCxhQUFhLEVBQ2IsaUJBQWlCLEVBQ2pCLEtBQUssRUFDTCxTQUFTLEVBT1YsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUdqRDtJQUlFLHVCQUMwQyxHQUFXLEVBQ25CLE9BQWdCLEVBQ3hDLE1BQTJCLEVBQzNCLE1BQWlCLEVBQ2pCLFNBQTBCO1FBSk0sUUFBRyxHQUFILEdBQUcsQ0FBUTtRQUNuQixZQUFPLEdBQVAsT0FBTyxDQUFTO1FBQ3hDLFdBQU0sR0FBTixNQUFNLENBQXFCO1FBQzNCLFdBQU0sR0FBTixNQUFNLENBQVc7UUFDakIsY0FBUyxHQUFULFNBQVMsQ0FBaUI7UUFSN0IsbUJBQWMsR0FBNEIsSUFBSSxhQUFh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cywgUGF5bWVudE1ldGhvZFJlc3VsdCB9IGZyb20gJy4vLi4vaW50ZXJmYWNlcy9wYXltZW50LW1ldGhvZCc7XG5kZWNsYXJlIHZhciBTdHJpcGU7XG5cbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZnJvbSBhcyBvYnNlcnZhYmxlRnJvbSwgT2JzZXJ2YWJsZSwgUmVwbGF5U3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIHB1Ymxpc2hMYXN0LCByZWZDb3VudCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEVsZW1lbnQsIFJlcXVlc3RFbGVtZW50T3B0aW9ucyB9IGZyb20gJy4uL2ludGVyZmFjZXMvZWxlbWVudCc7XG5pbXBvcnQgeyBFbGVtZW50cywgRWxlbWVudHNPcHRpb25zIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9lbGVtZW50cyc7XG5pbXBvcnQgeyBpc1NvdXJjZURhdGEsIFNvdXJjZURhdGEsIFNvdXJjZVBhcmFtcywgU291cmNlUmVzdWx0IH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zb3VyY2VzJztcbmltcG9ydCB7IE9wdGlvbnMsIFN0cmlwZUpTLCBTVFJJUEVfT1BUSU9OUywgU1RSSVBFX1BVQkxJU0hBQkxFX0tFWSB9IGZyb20gJy4uL2ludGVyZmFjZXMvc3RyaXBlJztcbmltcG9ydCB7XG4gIEJhbmtBY2NvdW50LFxuICBCYW5rQWNjb3VudERhdGEsXG4gIENhcmREYXRhT3B0aW9ucyxcbiAgQ2FyZFBheW1lbnREYXRhLFxuICBDb25maXJtQ2FyZFBheW1lbnREYXRhLFxuICBDb25maXJtQ2FyZFBheW1lbnRPcHRpb25zLFxuICBDb25maXJtQ2FyZFBheW1lbnRSZXN1bHQsXG4gIENvbmZpcm1JbnRlbnREYXRhLFxuICBDb25maXJtU2V0dXBJbnRlbnREYXRhLFxuICBpc0JhbmtBY2NvdW50LFxuICBpc0JhbmtBY2NvdW50RGF0YSxcbiAgaXNQaWksXG4gIGlzUGlpRGF0YSxcbiAgUGF5bWVudEludGVudFJlc3VsdCxcbiAgUGlpLFxuICBQaWlEYXRhLFxuICBTZXR1cEludGVudERhdGEsXG4gIFNldHVwSW50ZW50UmVzdWx0LFxuICBUb2tlblJlc3VsdFxufSBmcm9tICcuLi9pbnRlcmZhY2VzL3Rva2VuJztcbmltcG9ydCB7IExhenlTdHJpcGVBUElMb2FkZXIsIFN0YXR1cyB9IGZyb20gJy4vYXBpLWxvYWRlci5zZXJ2aWNlJztcbmltcG9ydCB7IFBsYXRmb3JtU2VydmljZSB9IGZyb20gJy4vcGxhdGZvcm0uc2VydmljZSc7XG5pbXBvcnQgeyBXaW5kb3dSZWYgfSBmcm9tICcuL3dpbmRvdy1yZWYuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTdHJpcGVTZXJ2aWNlIHtcbiAgcHVibGljIHN0cmlwZUNoYW5nZWQkOiBSZXBsYXlTdWJqZWN0PFN0cmlwZUpTPiA9IG5ldyBSZXBsYXlTdWJqZWN0KCk7XG4gIHByaXZhdGUgc3RyaXBlOiBTdHJpcGVKUyA9IHt9IGFzIFN0cmlwZUpTO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoU1RSSVBFX1BVQkxJU0hBQkxFX0tFWSkgcHJpdmF0ZSBrZXk6IHN0cmluZyxcbiAgICBASW5qZWN0KFNUUklQRV9PUFRJT05TKSBwcml2YXRlIG9wdGlvbnM6IE9wdGlvbnMsXG4gICAgcHJpdmF0ZSBsb2FkZXI6IExhenlTdHJpcGVBUElMb2FkZXIsXG4gICAgcHJpdmF0ZSB3aW5kb3c6IFdpbmRvd1JlZixcbiAgICBwcml2YXRlIF9wbGF0Zm9ybTogUGxhdGZvcm1TZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuY2hhbmdlS2V5KHRoaXMua2V5LCB0aGlzLm9wdGlvbnMpXG4gICAgICAucGlwZSh0YWtlKDEpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7fSk7XG4gIH1cblxuICBwdWJsaWMgY2hhbmdlS2V5KGtleTogc3RyaW5nLCBvcHRpb25zPzogT3B0aW9ucyk6IE9ic2VydmFibGU8U3RyaXBlSlMgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBvYnMgPSB0aGlzLmxvYWRlci5hc1N0cmVhbSgpLnBpcGUoXG4gICAgICBmaWx0ZXIoKHN0YXR1czogU3RhdHVzKSA9PiBzdGF0dXMubG9hZGVkID09PSB0cnVlKSxcbiAgICAgIG1hcCgoKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy53aW5kb3cuZ2V0TmF0aXZlV2luZG93KCkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgU3RyaXBlID0gKHRoaXMud2luZG93LmdldE5hdGl2ZVdpbmRvdygpIGFzIGFueSkuU3RyaXBlO1xuICAgICAgICBpZiAoa2V5KSB7XG4gICAgICAgICAgdGhpcy5zdHJpcGUgPSBvcHRpb25zID8gKFN0cmlwZShrZXksIG9wdGlvbnMpIGFzIFN0cmlwZUpTKSA6IChTdHJpcGUoa2V5KSBhcyBTdHJpcGVKUyk7XG4gICAgICAgICAgdGhpcy5zdHJpcGVDaGFuZ2VkJC5uZXh0KHRoaXMuc3RyaXBlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zdHJpcGU7XG4gICAgICB9KSxcbiAgICAgIHB1Ymxpc2hMYXN0KCksXG4gICAgICByZWZDb3VudCgpXG4gICAgKTtcbiAgICBvYnMuc3Vic2NyaWJlKCk7XG4gICAgcmV0dXJuIG9icztcbiAgfVxuXG4gIHB1YmxpYyBlbGVtZW50cyhvcHRpb25zPzogRWxlbWVudHNPcHRpb25zKTogT2JzZXJ2YWJsZTxFbGVtZW50cz4ge1xuICAgIHJldHVybiB0aGlzLnN0cmlwZUNoYW5nZWQkLnBpcGUobWFwKCgpID0+IHRoaXMuc3RyaXBlLmVsZW1lbnRzKG9wdGlvbnMpKSk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVG9rZW4oXG4gICAgYTogRWxlbWVudCB8IEJhbmtBY2NvdW50IHwgUGlpLFxuICAgIGI6IENhcmREYXRhT3B0aW9ucyB8IEJhbmtBY2NvdW50RGF0YSB8IFBpaURhdGEgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxUb2tlblJlc3VsdD4ge1xuICAgIGlmIChpc0JhbmtBY2NvdW50KGEpICYmIGlzQmFua0FjY291bnREYXRhKGIpKSB7XG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY3JlYXRlVG9rZW4oYSwgYikpO1xuICAgIH0gZWxzZSBpZiAoaXNQaWkoYSkgJiYgaXNQaWlEYXRhKGIpKSB7XG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY3JlYXRlVG9rZW4oYSwgYikpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY3JlYXRlVG9rZW4oYSBhcyBFbGVtZW50LCBiIGFzIENhcmREYXRhT3B0aW9ucyB8IHVuZGVmaW5lZCkpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBwYXltZW50UmVxdWVzdChvcHRpb25zOiBSZXF1ZXN0RWxlbWVudE9wdGlvbnMpOiBPYnNlcnZhYmxlPEVsZW1lbnQ+IHtcbiAgICByZXR1cm4gdGhpcy5zdHJpcGVDaGFuZ2VkJC5waXBlKG1hcCgoKSA9PiB0aGlzLnN0cmlwZS5wYXltZW50UmVxdWVzdChvcHRpb25zKSkpO1xuICB9XG5cbiAgcHVibGljIGhhbmRsZUNhcmRTZXR1cChcbiAgICBjbGllbnRTZWNyZXQ6IHN0cmluZyxcbiAgICBlbGVtZW50OiBFbGVtZW50LFxuICAgIGNhcmRTZXR1cE9wdGlvbnM/OiBTZXR1cEludGVudERhdGEgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxTZXR1cEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5oYW5kbGVDYXJkU2V0dXAoY2xpZW50U2VjcmV0LCBlbGVtZW50LCBjYXJkU2V0dXBPcHRpb25zKSk7XG4gIH1cblxuICBwdWJsaWMgaGFuZGxlQ2FyZFBheW1lbnQoXG4gICAgY2xpZW50U2VjcmV0OiBzdHJpbmcsXG4gICAgZWxlbWVudDogRWxlbWVudCxcbiAgICBjYXJkU2V0dXBPcHRpb25zPzogQ2FyZFBheW1lbnREYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8UGF5bWVudEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5oYW5kbGVDYXJkUGF5bWVudChjbGllbnRTZWNyZXQsIGVsZW1lbnQsIGNhcmRTZXR1cE9wdGlvbnMpKTtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVDYXJkQWN0aW9uKGNsaWVudFNlY3JldDogc3RyaW5nKTogT2JzZXJ2YWJsZTxQYXltZW50SW50ZW50UmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmhhbmRsZUNhcmRBY3Rpb24oY2xpZW50U2VjcmV0KSk7XG4gIH1cblxuICBwdWJsaWMgY29uZmlybVBheW1lbnRJbnRlbnQoXG4gICAgY2xpZW50U2VjcmV0OiBzdHJpbmcsXG4gICAgZWxlbWVudDogRWxlbWVudCxcbiAgICBpbnRlbnRPcHRpb25zPzogQ29uZmlybUludGVudERhdGEgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxTZXR1cEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jb25maXJtUGF5bWVudEludGVudChjbGllbnRTZWNyZXQsIGVsZW1lbnQsIGludGVudE9wdGlvbnMpKTtcbiAgfVxuXG4gIHB1YmxpYyBjb25maXJtQ2FyZFBheW1lbnQoXG4gICAgY2xpZW50U2VjcmV0OiBzdHJpbmcsXG4gICAgZGF0YTogQ29uZmlybUNhcmRQYXltZW50RGF0YSxcbiAgICBvcHRpb25zPzogQ29uZmlybUNhcmRQYXltZW50T3B0aW9ucyB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPENvbmZpcm1DYXJkUGF5bWVudFJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jb25maXJtQ2FyZFBheW1lbnQoY2xpZW50U2VjcmV0LCBkYXRhLCBvcHRpb25zKSk7XG4gIH1cblxuICBwdWJsaWMgcmV0cmlldmVQYXltZW50SW50ZW50KGNsaWVudFNlY3JldDogc3RyaW5nKTogT2JzZXJ2YWJsZTxQYXltZW50SW50ZW50UmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLnJldHJpZXZlUGF5bWVudEludGVudChjbGllbnRTZWNyZXQpKTtcbiAgfVxuXG4gIHB1YmxpYyByZXRyaWV2ZVNldHVwSW50ZW50KGNsaWVudFNlY3JldDogc3RyaW5nKTogT2JzZXJ2YWJsZTxTZXR1cEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5yZXRyaWV2ZVNldHVwSW50ZW50KGNsaWVudFNlY3JldCkpO1xuICB9XG5cbiAgcHVibGljIGNvbmZpcm1TZXR1cEludGVudChcbiAgICBjbGllbnRTZWNyZXQ6IHN0cmluZyxcbiAgICBlbGVtZW50OiBFbGVtZW50LFxuICAgIGludGVudE9wdGlvbnM/OiBDb25maXJtU2V0dXBJbnRlbnREYXRhIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8U2V0dXBJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY29uZmlybVNldHVwSW50ZW50KGNsaWVudFNlY3JldCwgZWxlbWVudCwgaW50ZW50T3B0aW9ucykpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVNvdXJjZShhOiBFbGVtZW50IHwgU291cmNlRGF0YSwgYj86IFNvdXJjZURhdGEgfCB1bmRlZmluZWQpOiBPYnNlcnZhYmxlPFNvdXJjZVJlc3VsdD4ge1xuICAgIGlmIChpc1NvdXJjZURhdGEoYSkpIHtcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jcmVhdGVTb3VyY2UoYSBhcyBTb3VyY2VEYXRhKSk7XG4gICAgfVxuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jcmVhdGVTb3VyY2UoYSBhcyBFbGVtZW50LCBiKSk7XG4gIH1cblxuICBwdWJsaWMgcmV0cmlldmVTb3VyY2Uoc291cmNlOiBTb3VyY2VQYXJhbXMpOiBPYnNlcnZhYmxlPFNvdXJjZVJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5yZXRyaWV2ZVNvdXJjZShzb3VyY2UpKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVQYXltZW50TWV0aG9kKHBheW1lbnRNZXRob2Q6IFBheW1lbnRNZXRob2RQYXJhbXMpOiBPYnNlcnZhYmxlPFBheW1lbnRNZXRob2RSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuY3JlYXRlUGF5bWVudE1ldGhvZChwYXltZW50TWV0aG9kKSk7XG4gIH1cbn1cbiJdfQ==