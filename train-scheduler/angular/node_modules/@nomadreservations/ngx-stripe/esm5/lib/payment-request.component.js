import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { BehaviorSubject, combineLatest, ReplaySubject, Subject } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { StripeService } from './services/stripe.service';
var PaymentRequestComponent = /** @class */ (function () {
    function PaymentRequestComponent(stripeService) {
        this.stripeService = stripeService;
        this.change = new EventEmitter();
        this.shippingAddressChange = new EventEmitter();
        this.shippingOptionChange = new EventEmitter();
        this.cancel = new EventEmitter();
        this.hide = false;
        this.styles$ = new BehaviorSubject({});
        this.options$ = new ReplaySubject();
        this.elementsOptions$ = new BehaviorSubject({});
        this.complete$ = new Subject();
        this._attached = false;
        this._opened = false;
    }
    Object.defineProperty(PaymentRequestComponent.prototype, "options", {
        set: function (optionsIn) {
            this.options$.next(optionsIn);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PaymentRequestComponent.prototype, "elementsOptions", {
        set: function (optionsIn) {
            this.elementsOptions$.next(optionsIn);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PaymentRequestComponent.prototype, "styles", {
        set: function (optionsIn) {
            this.styles$.next(optionsIn);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PaymentRequestComponent.prototype, "complete", {
        set: function (success) {
            this.complete$.next(success);
        },
        enumerable: true,
        configurable: true
    });
    PaymentRequestComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.elements$ = this.elementsOptions$.asObservable().pipe(switchMap(function (options) {
            return _this.stripeService.elements(options);
        }));
        this.request$ = this.options$.asObservable().pipe(switchMap(function (options) {
            return _this.stripeService.paymentRequest(options);
        }));
        this.complete$.subscribe(function (complete) {
            if (_this.lastEvent) {
                if (complete) {
                    _this.lastEvent.complete('success');
                }
                else {
                    _this.lastEvent.complete('fail');
                }
            }
        });
    };
    PaymentRequestComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        combineLatest(this.request$, this.elements$, this.options$, this.styles$).subscribe(function (_a) {
            var _b = tslib_1.__read(_a, 4), paymentRequest = _b[0], elements = _b[1], options = _b[2], styles = _b[3];
            if (_this.requestButton && !_this._attached) {
                _this._paymentRequest = paymentRequest;
                _this._attached = true;
                var element_1 = elements.create('paymentRequestButton', {
                    paymentRequest: paymentRequest,
                    style: {
                        paymentRequestButton: tslib_1.__assign({}, styles)
                    }
                });
                _this.hide = false;
                paymentRequest.canMakePayment().then(function (result) {
                    if (result) {
                        element_1.mount(_this.requestButton.nativeElement);
                    }
                    else {
                        _this.hide = true;
                    }
                });
                paymentRequest.on('shippingaddresschange', function (event) {
                    _this.shippingAddressChange.emit(event);
                });
                paymentRequest.on('shippingoptionchange', function (event) {
                    _this.shippingOptionChange.emit(event);
                });
                paymentRequest.on('token', function (event) {
                    _this.change.emit(event);
                    _this._opened = false;
                });
                paymentRequest.on('paymentmethod', function (event) {
                    _this.change.emit(event);
                });
                paymentRequest.on('source', function (event) {
                    _this.change.emit(event);
                });
                paymentRequest.on('cancel', function (event) {
                    _this.cancel.emit(event);
                    _this._opened = false;
                });
                paymentRequest.on('click', function () {
                    _this._opened = true;
                });
            }
            else if (_this._attached && !_this._opened) {
                _this._paymentRequest.update({
                    currency: options.currency,
                    total: options.total,
                    displayItems: options.displayItems,
                    shippingOptions: options.shippingOptions
                });
            }
        });
    };
    PaymentRequestComponent.ctorParameters = function () { return [
        { type: StripeService }
    ]; };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], PaymentRequestComponent.prototype, "options", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], PaymentRequestComponent.prototype, "elementsOptions", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], PaymentRequestComponent.prototype, "styles", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean),
        tslib_1.__metadata("design:paramtypes", [Boolean])
    ], PaymentRequestComponent.prototype, "complete", null);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], PaymentRequestComponent.prototype, "change", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], PaymentRequestComponent.prototype, "shippingAddressChange", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], PaymentRequestComponent.prototype, "shippingOptionChange", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], PaymentRequestComponent.prototype, "cancel", void 0);
    tslib_1.__decorate([
        ViewChild('request', { static: false }),
        tslib_1.__metadata("design:type", ElementRef)
    ], PaymentRequestComponent.prototype, "requestButton", void 0);
    PaymentRequestComponent = tslib_1.__decorate([
        Component({
            selector: 'ngx-payment-request',
            template: '<div #request [style.display-none]="hide"></div>'
        }),
        tslib_1.__metadata("design:paramtypes", [StripeService])
    ], PaymentRequestComponent);
    return PaymentRequestComponent;
}());
export { PaymentRequestComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF5bWVudC1yZXF1ZXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bub21hZHJlc2VydmF0aW9ucy9uZ3gtc3RyaXBlLyIsInNvdXJjZXMiOlsibGliL3BheW1lbnQtcmVxdWVzdC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBaUIsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckgsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQWMsYUFBYSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxRixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFLM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBTTFEO0lBcUJFLGlDQUFvQixhQUE0QjtRQUE1QixrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUMvQixXQUFNLEdBQUcsSUFBSSxZQUFZLEVBbUJ0QyxDQUFDO1FBQ1ksMEJBQXFCLEdBQUcsSUFBSSxZQUFZLEVBR3JELENBQUM7UUFDWSx5QkFBb0IsR0FBRyxJQUFJLFlBQVksRUFHcEQsQ0FBQztRQUNZLFdBQU0sR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBRTNDLFNBQUksR0FBRyxLQUFLLENBQUM7UUFHWixZQUFPLEdBQUcsSUFBSSxlQUFlLENBQTRCLEVBQUUsQ0FBQyxDQUFDO1FBQzdELGFBQVEsR0FBRyxJQUFJLGFBQWEsRUFBeUIsQ0FBQztRQUN0RCxxQkFBZ0IsR0FBRyxJQUFJLGVBQWUsQ0FBa0IsRUFBRSxDQUFDLENBQUM7UUFFNUQsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFDbkMsY0FBUyxHQUFHLEtBQUssQ0FBQztRQUNsQixZQUFPLEdBQUcsS0FBSyxDQUFDO0lBeEMyQixDQUFDO0lBbkJwRCxzQkFBWSw0Q0FBTzth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Q0FBQyxPQUFPLEVBQUU7Z0JBQzFDLEtBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDO29CQUMxQixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7b0JBQzFCLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSztvQkFDcEIsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZO29CQUNsQyxlQUFlLEVBQUUsT0FBTyxDQUFDLGVBQWU7aUJBQ3pDLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUNGLENBQUM7SUFDSixDQUFDOztnQkExSGtDLGFBQWE7O0lBbkJoRDtRQURDLEtBQUssRUFBRTs7OzBEQUdQO0lBR0Q7UUFEQyxLQUFLLEVBQUU7OztrRUFHUDtJQUdEO1FBREMsS0FBSyxFQUFFOzs7eURBR1A7SUFHRDtRQURDLEtBQUssRUFBRTs7OzJEQUdQO0lBR1M7UUFBVCxNQUFNLEVBQUU7OzJEQW1CSjtJQUNLO1FBQVQsTUFBTSxFQUFFOzswRUFHSjtJQUNLO1FBQVQsTUFBTSxFQUFFOzt5RUFHSjtJQUNLO1FBQVQsTUFBTSxFQUFFOzsyREFBeUM7SUFJVDtRQUF4QyxTQUFTLENBQUMsU0FBUyxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDOzBDQUF5QixVQUFVO2tFQUFDO0lBdERqRSx1QkFBdUI7UUFKbkMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHFCQUFxQjtZQUMvQixRQUFRLEVBQUUsa0RBQWtEO1NBQzdELENBQUM7aURBc0JtQyxhQUFhO09BckJyQyx1QkFBdUIsQ0FnSm5DO0lBQUQsOEJBQUM7Q0FBQSxBQWhKRCxJQWdKQztTQWhKWSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE9uSW5pdCwgT3V0cHV0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgUmVwbGF5U3ViamVjdCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUGF5bWVudFJlcXVlc3RCdXR0b25TdHlsZSwgUmVxdWVzdEVsZW1lbnRPcHRpb25zLCBVcGRhdGVEZXRhaWxzIH0gZnJvbSAnLi9pbnRlcmZhY2VzL2VsZW1lbnQnO1xuaW1wb3J0IHsgRWxlbWVudHNPcHRpb25zIH0gZnJvbSAnLi9pbnRlcmZhY2VzL2VsZW1lbnRzJztcbmltcG9ydCB7IFNvdXJjZSB9IGZyb20gJy4vaW50ZXJmYWNlcy9zb3VyY2VzJztcbmltcG9ydCB7IFNoaXBwaW5nQWRkcmVzcywgU2hpcHBpbmdPcHRpb25zLCBUb2tlbiB9IGZyb20gJy4vaW50ZXJmYWNlcy90b2tlbic7XG5pbXBvcnQgeyBTdHJpcGVTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9zdHJpcGUuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ25neC1wYXltZW50LXJlcXVlc3QnLFxuICB0ZW1wbGF0ZTogJzxkaXYgI3JlcXVlc3QgW3N0eWxlLmRpc3BsYXktbm9uZV09XCJoaWRlXCI+PC9kaXY+J1xufSlcbmV4cG9ydCBjbGFzcyBQYXltZW50UmVxdWVzdENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCB7XG4gIEBJbnB1dCgpXG4gIHByaXZhdGUgc2V0IG9wdGlvbnMob3B0aW9uc0luOiBSZXF1ZXN0RWxlbWVudE9wdGlvbnMpIHtcbiAgICB0aGlzLm9wdGlvbnMkLm5leHQob3B0aW9uc0luKTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBzZXQgZWxlbWVudHNPcHRpb25zKG9wdGlvbnNJbjogRWxlbWVudHNPcHRpb25zKSB7XG4gICAgdGhpcy5lbGVtZW50c09wdGlvbnMkLm5leHQob3B0aW9uc0luKTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBzZXQgc3R5bGVzKG9wdGlvbnNJbjogUGF5bWVudFJlcXVlc3RCdXR0b25TdHlsZSkge1xuICAgIHRoaXMuc3R5bGVzJC5uZXh0KG9wdGlvbnNJbik7XG4gIH1cblxuICBASW5wdXQoKVxuICBwdWJsaWMgc2V0IGNvbXBsZXRlKHN1Y2Nlc3M6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmNvbXBsZXRlJC5uZXh0KHN1Y2Nlc3MpO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzdHJpcGVTZXJ2aWNlOiBTdHJpcGVTZXJ2aWNlKSB7fVxuICBAT3V0cHV0KCkgcHVibGljIGNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8e1xuICAgIHRva2VuPzogVG9rZW47XG4gICAgcGF5bWVudE1ldGhvZD86IFBheW1lbnRNZXRob2REYXRhO1xuICAgIHNvdXJjZT86IFNvdXJjZTtcbiAgICBjb21wbGV0ZTogKFxuICAgICAgc3RhdHVzOlxuICAgICAgICB8ICdzdWNjZXNzJ1xuICAgICAgICB8ICdmYWlsJ1xuICAgICAgICB8ICdpbnZhbGlkX3BheWVyX25hbWUnXG4gICAgICAgIHwgJ2ludmFsaWRfcGF5ZXJfcGhvbmUnXG4gICAgICAgIHwgJ2ludmFsaWRfcGF5ZXJfZW1haWwnXG4gICAgICAgIHwgJ2ludmFsaWRfc2hpcHBpbmdfYWRkcmVzcydcbiAgICApID0+IHt9O1xuICAgIHBheWVyTmFtZT86IHN0cmluZztcbiAgICBwYXllckVtYWlsPzogc3RyaW5nO1xuICAgIHBheWVyUGhvbmU/OiBzdHJpbmc7XG4gICAgc2hpcHBpbmdBZGRyZXNzPzogU2hpcHBpbmdBZGRyZXNzO1xuICAgIHNoaXBwaW5nT3B0aW9uPzogU2hpcHBpbmdPcHRpb25zO1xuICAgIG1ldGhvZE5hbWU/OiBzdHJpbmc7XG4gIH0+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgc2hpcHBpbmdBZGRyZXNzQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjx7XG4gICAgdXBkYXRlV2l0aDogKHVwZGF0ZURldGFpbHM6IFVwZGF0ZURldGFpbHMpID0+IHt9O1xuICAgIHNoaXBwaW5nQWRkcmVzczogU2hpcHBpbmdBZGRyZXNzO1xuICB9PigpO1xuICBAT3V0cHV0KCkgcHVibGljIHNoaXBwaW5nT3B0aW9uQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjx7XG4gICAgdXBkYXRlV2l0aDogKHVwZGF0ZURldGFpbHM6IFVwZGF0ZURldGFpbHMpID0+IHt9O1xuICAgIHNoaXBwaW5nT3B0aW9uOiBTaGlwcGluZ09wdGlvbnM7XG4gIH0+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgY2FuY2VsID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgcHVibGljIGhpZGUgPSBmYWxzZTtcblxuICBAVmlld0NoaWxkKCdyZXF1ZXN0JywgeyBzdGF0aWM6IGZhbHNlIH0pIHByaXZhdGUgcmVxdWVzdEJ1dHRvbj86IEVsZW1lbnRSZWY7XG4gIHByaXZhdGUgc3R5bGVzJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UGF5bWVudFJlcXVlc3RCdXR0b25TdHlsZT4oe30pO1xuICBwcml2YXRlIG9wdGlvbnMkID0gbmV3IFJlcGxheVN1YmplY3Q8UmVxdWVzdEVsZW1lbnRPcHRpb25zPigpO1xuICBwcml2YXRlIGVsZW1lbnRzT3B0aW9ucyQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEVsZW1lbnRzT3B0aW9ucz4oe30pO1xuICBwcml2YXRlIGxhc3RFdmVudDogYW55O1xuICBwcml2YXRlIGNvbXBsZXRlJCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG4gIHByaXZhdGUgX2F0dGFjaGVkID0gZmFsc2U7XG4gIHByaXZhdGUgX29wZW5lZCA9IGZhbHNlO1xuICBwcml2YXRlIF9wYXltZW50UmVxdWVzdDogYW55O1xuXG4gIHByaXZhdGUgZWxlbWVudHMkOiBPYnNlcnZhYmxlPGFueT47XG4gIHByaXZhdGUgcmVxdWVzdCQ6IE9ic2VydmFibGU8YW55PjtcblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmVsZW1lbnRzJCA9IHRoaXMuZWxlbWVudHNPcHRpb25zJC5hc09ic2VydmFibGUoKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKG9wdGlvbnMgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdHJpcGVTZXJ2aWNlLmVsZW1lbnRzKG9wdGlvbnMpO1xuICAgICAgfSlcbiAgICApO1xuICAgIHRoaXMucmVxdWVzdCQgPSB0aGlzLm9wdGlvbnMkLmFzT2JzZXJ2YWJsZSgpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAob3B0aW9ucyA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0cmlwZVNlcnZpY2UucGF5bWVudFJlcXVlc3Qob3B0aW9ucyk7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICB0aGlzLmNvbXBsZXRlJC5zdWJzY3JpYmUoY29tcGxldGUgPT4ge1xuICAgICAgaWYgKHRoaXMubGFzdEV2ZW50KSB7XG4gICAgICAgIGlmIChjb21wbGV0ZSkge1xuICAgICAgICAgIHRoaXMubGFzdEV2ZW50LmNvbXBsZXRlKCdzdWNjZXNzJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5sYXN0RXZlbnQuY29tcGxldGUoJ2ZhaWwnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICBjb21iaW5lTGF0ZXN0KHRoaXMucmVxdWVzdCQsIHRoaXMuZWxlbWVudHMkLCB0aGlzLm9wdGlvbnMkLCB0aGlzLnN0eWxlcyQpLnN1YnNjcmliZShcbiAgICAgIChbcGF5bWVudFJlcXVlc3QsIGVsZW1lbnRzLCBvcHRpb25zLCBzdHlsZXNdKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnJlcXVlc3RCdXR0b24gJiYgIXRoaXMuX2F0dGFjaGVkKSB7XG4gICAgICAgICAgdGhpcy5fcGF5bWVudFJlcXVlc3QgPSBwYXltZW50UmVxdWVzdDtcbiAgICAgICAgICB0aGlzLl9hdHRhY2hlZCA9IHRydWU7XG4gICAgICAgICAgY29uc3QgZWxlbWVudCA9IGVsZW1lbnRzLmNyZWF0ZSgncGF5bWVudFJlcXVlc3RCdXR0b24nLCB7XG4gICAgICAgICAgICBwYXltZW50UmVxdWVzdCxcbiAgICAgICAgICAgIHN0eWxlOiB7XG4gICAgICAgICAgICAgIHBheW1lbnRSZXF1ZXN0QnV0dG9uOiB7IC4uLnN0eWxlcyB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICB0aGlzLmhpZGUgPSBmYWxzZTtcbiAgICAgICAgICBwYXltZW50UmVxdWVzdC5jYW5NYWtlUGF5bWVudCgpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgZWxlbWVudC5tb3VudCh0aGlzLnJlcXVlc3RCdXR0b24ubmF0aXZlRWxlbWVudCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aGlzLmhpZGUgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHBheW1lbnRSZXF1ZXN0Lm9uKCdzaGlwcGluZ2FkZHJlc3NjaGFuZ2UnLCBldmVudCA9PiB7XG4gICAgICAgICAgICB0aGlzLnNoaXBwaW5nQWRkcmVzc0NoYW5nZS5lbWl0KGV2ZW50KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwYXltZW50UmVxdWVzdC5vbignc2hpcHBpbmdvcHRpb25jaGFuZ2UnLCBldmVudCA9PiB7XG4gICAgICAgICAgICB0aGlzLnNoaXBwaW5nT3B0aW9uQ2hhbmdlLmVtaXQoZXZlbnQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHBheW1lbnRSZXF1ZXN0Lm9uKCd0b2tlbicsIGV2ZW50ID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlLmVtaXQoZXZlbnQpO1xuICAgICAgICAgICAgdGhpcy5fb3BlbmVkID0gZmFsc2U7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcGF5bWVudFJlcXVlc3Qub24oJ3BheW1lbnRtZXRob2QnLCBldmVudCA9PiB7XG4gICAgICAgICAgICB0aGlzLmNoYW5nZS5lbWl0KGV2ZW50KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBwYXltZW50UmVxdWVzdC5vbignc291cmNlJywgZXZlbnQgPT4ge1xuICAgICAgICAgICAgdGhpcy5jaGFuZ2UuZW1pdChldmVudCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcGF5bWVudFJlcXVlc3Qub24oJ2NhbmNlbCcsIGV2ZW50ID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2FuY2VsLmVtaXQoZXZlbnQpO1xuICAgICAgICAgICAgdGhpcy5fb3BlbmVkID0gZmFsc2U7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcGF5bWVudFJlcXVlc3Qub24oJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fb3BlbmVkID0gdHJ1ZTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9hdHRhY2hlZCAmJiAhdGhpcy5fb3BlbmVkKSB7XG4gICAgICAgICAgdGhpcy5fcGF5bWVudFJlcXVlc3QudXBkYXRlKHtcbiAgICAgICAgICAgIGN1cnJlbmN5OiBvcHRpb25zLmN1cnJlbmN5LFxuICAgICAgICAgICAgdG90YWw6IG9wdGlvbnMudG90YWwsXG4gICAgICAgICAgICBkaXNwbGF5SXRlbXM6IG9wdGlvbnMuZGlzcGxheUl0ZW1zLFxuICAgICAgICAgICAgc2hpcHBpbmdPcHRpb25zOiBvcHRpb25zLnNoaXBwaW5nT3B0aW9uc1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgKTtcbiAgfVxufVxuIl19