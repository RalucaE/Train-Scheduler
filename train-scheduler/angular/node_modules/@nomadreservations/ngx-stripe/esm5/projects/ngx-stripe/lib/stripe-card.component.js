import * as tslib_1 from "tslib";
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { BehaviorSubject, combineLatest as observableCombineLatest } from 'rxjs';
import { filter, switchMap } from 'rxjs/operators';
import { StripeService } from './services/stripe.service';
var StripeCardComponent = /** @class */ (function () {
    function StripeCardComponent(stripeService) {
        this.stripeService = stripeService;
        this.change = new EventEmitter();
        this.complete = new EventEmitter();
        this.error = new EventEmitter();
        this.elementTypes = ['card'];
        this.options$ = new BehaviorSubject({});
        this.elementsOptions$ = new BehaviorSubject({});
    }
    Object.defineProperty(StripeCardComponent.prototype, "options", {
        set: function (optionsIn) {
            this.options$.next(optionsIn);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(StripeCardComponent.prototype, "elementsOptions", {
        set: function (optionsIn) {
            this.elementsOptions$.next(optionsIn);
        },
        enumerable: true,
        configurable: true
    });
    StripeCardComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        var elements$ = this.elementsOptions$.asObservable().pipe(switchMap(function (options) {
            if (Object.keys(options).length > 0) {
                return _this.stripeService.elements(options);
            }
            return _this.stripeService.elements();
        }));
        var complete = {};
        observableCombineLatest(elements$, this.options$.asObservable().pipe(filter(function (options) { return Boolean(options); }))).subscribe(function (_a) {
            var e_1, _b;
            var _c = tslib_1.__read(_a, 2), elements = _c[0], options = _c[1];
            _this.elements = [];
            if (_this.card) {
                var _loop_1 = function (type) {
                    var _a;
                    var element = elements.create(type, options);
                    complete = tslib_1.__assign({}, complete, (_a = {}, _a[type] = element, _a));
                    if (['card', 'cardNumber'].indexOf(type) !== -1) {
                        _this.cardElement = element;
                    }
                    var mountTo = _this.card.nativeElement.querySelector("." + type);
                    element.mount(mountTo);
                    element.on('change', function (changedCard) {
                        var isComplete = changedCard.complete;
                        for (var key in complete) {
                            if (complete) {
                                var value = complete[key];
                                if (key !== changedCard.elementType && !value._complete) {
                                    isComplete = false;
                                }
                            }
                        }
                        _this.change.emit({
                            card: changedCard,
                            elements: _this.elements,
                            type: changedCard.elementType,
                            complete: isComplete,
                            element: element
                        });
                        if (isComplete) {
                            _this.complete.emit({
                                card: changedCard,
                                elements: _this.elements,
                                type: changedCard.elementType,
                                complete: isComplete,
                                element: element
                            });
                        }
                        if (changedCard.error) {
                            _this.error.emit(changedCard.error);
                        }
                    });
                    _this.elements = tslib_1.__spread(_this.elements, [element]);
                };
                try {
                    for (var _d = tslib_1.__values(_this.elementTypes), _e = _d.next(); !_e.done; _e = _d.next()) {
                        var type = _e.value;
                        _loop_1(type);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (_e && !_e.done && (_b = _d.return)) _b.call(_d);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
            }
        });
    };
    StripeCardComponent.prototype.getCard = function () {
        return this.cardElement;
    };
    StripeCardComponent.ctorParameters = function () { return [
        { type: StripeService }
    ]; };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], StripeCardComponent.prototype, "options", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], StripeCardComponent.prototype, "elementsOptions", null);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], StripeCardComponent.prototype, "change", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], StripeCardComponent.prototype, "complete", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", Object)
    ], StripeCardComponent.prototype, "error", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Array)
    ], StripeCardComponent.prototype, "elementTypes", void 0);
    tslib_1.__decorate([
        ViewChild('card', { static: false }),
        tslib_1.__metadata("design:type", ElementRef)
    ], StripeCardComponent.prototype, "card", void 0);
    StripeCardComponent = tslib_1.__decorate([
        Component({
            selector: 'ngx-stripe-card',
            template: "\n    <div class=\"field\" #card>\n      <div [class]=\"type\" *ngFor=\"let type of elementTypes\"></div>\n    </div>\n  "
        }),
        tslib_1.__metadata("design:paramtypes", [StripeService])
    ], StripeCardComponent);
    return StripeCardComponent;
}());
export { StripeCardComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLWNhcmQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5vbWFkcmVzZXJ2YXRpb25zL25neC1zdHJpcGUvcHJvamVjdHMvbmd4LXN0cmlwZS8iLCJzb3VyY2VzIjpbImxpYi9zdHJpcGUtY2FyZC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBaUIsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0csT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLElBQUksdUJBQXVCLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDN0YsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUduRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFVMUQ7SUFXRSw2QkFBb0IsYUFBNEI7UUFBNUIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDL0IsV0FBTSxHQUFHLElBQUksWUFBWSxFQUF5QyxDQUFDO1FBQ25FLGFBQVEsR0FBRyxJQUFJLFlBQVksRUFBeUMsQ0FBQztRQUNyRSxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNqQyxpQkFBWSxHQUF1QixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBS3BELGFBQVEsR0FBRyxJQUFJLGVBQWUsQ0FBaUIsRUFBRSxDQUFDLENBQUM7UUFDbkQscUJBQWdCLEdBQUcsSUFBSSxlQUFlLENBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBVmpCLENBQUM7SUFUcEQsc0JBQVksd0NBQU87YUFBbkIsVUFBb0IsU0FBeUI7WUFDM0MsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDaEMsQ0FBQzs7O09BQUE7SUFHRCxzQkFBVyxnREFBZTthQUExQixVQUEyQixTQUEwQjtZQUNuRCxJQUFJLENBQUMsZ0JB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SSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO3lCQUNwQztvQkFDSCxDQUFDLENBQUMsQ0FBQztvQkFDSCxLQUFJLENBQUMsUUFBUSxvQkFBTyxLQUFJLENBQUMsUUFBUSxHQUFFLE9BQU8sRUFBQyxDQUFDOzs7b0JBNUM5QyxLQUFtQixJQUFBLEtBQUEsaUJBQUEsS0FBSSxDQUFDLFlBQVksQ0FBQSxnQkFBQTt3QkFBL0IsSUFBTSxJQUFJLFdBQUE7Z0NBQUosSUFBSTtxQkE2Q2Q7Ozs7Ozs7OzthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0scUNBQU8sR0FBZDtRQUNFLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDOztnQkFoRmtDLGFBQWE7O0lBVGhEO1FBREMsS0FBSyxFQUFFOzs7c0RBR1A7SUFHRDtRQURDLEtBQUssRUFBRTs7OzhEQUdQO0lBR1M7UUFBVCxNQUFNLEVBQUU7O3VEQUEyRTtJQUMxRTtRQUFULE1BQU0sRUFBRTs7eURBQTZFO0lBQzVFO1FBQVQsTUFBTSxFQUFFOztzREFBd0M7SUFDeEM7UUFBUixLQUFLLEVBQUU7MENBQXNCLEtBQUs7NkRBQXlCO0lBRXRCO1FBQXJDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7MENBQWUsVUFBVTtxREFBQztJQWpCcEQsbUJBQW1CO1FBUi9CLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxpQkFBaUI7WUFDM0IsUUFBUSxFQUFFLDJIQUlUO1NBQ0YsQ0FBQztpREFZbUMsYUFBYTtPQVhyQyxtQkFBbUIsQ0E0Ri9CO0lBQUQsMEJBQUM7Q0FBQSxBQTVGRCxJQTRGQztTQTVGWSxtQkFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE91dHB1dCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QgYXMgb2JzZXJ2YWJsZUNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRWxlbWVudCBhcyBTdHJpcGVFbGVtZW50LCBFbGVtZW50T3B0aW9ucywgRWxlbWVudFR5cGUgfSBmcm9tICcuL2ludGVyZmFjZXMvZWxlbWVudCc7XG5pbXBvcnQgeyBFbGVtZW50cywgRWxlbWVudHNPcHRpb25zIH0gZnJvbSAnLi9pbnRlcmZhY2VzL2VsZW1lbnRzJztcbmltcG9ydCB7IFN0cmlwZVNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3N0cmlwZS5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmd4LXN0cmlwZS1jYXJkJyxcbiAgdGVtcGxhdGU6IGBcbiAgICA8ZGl2IGNsYXNzPVwiZmllbGRcIiAjY2FyZD5cbiAgICAgIDxkaXYgW2NsYXNzXT1cInR5cGVcIiAqbmdGb3I9XCJsZXQgdHlwZSBvZiBlbGVtZW50VHlwZXNcIj48L2Rpdj5cbiAgICA8L2Rpdj5cbiAgYFxufSlcbmV4cG9ydCBjbGFzcyBTdHJpcGVDYXJkQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCB7XG4gIEBJbnB1dCgpXG4gIHByaXZhdGUgc2V0IG9wdGlvbnMob3B0aW9uc0luOiBFbGVtZW50T3B0aW9ucykge1xuICAgIHRoaXMub3B0aW9ucyQubmV4dChvcHRpb25zSW4pO1xuICB9XG5cbiAgQElucHV0KClcbiAgcHVibGljIHNldCBlbGVtZW50c09wdGlvbnMob3B0aW9uc0luOiBFbGVtZW50c09wdGlvbnMpIHtcbiAgICB0aGlzLmVsZW1lbnRzT3B0aW9ucyQubmV4dChvcHRpb25zSW4pO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzdHJpcGVTZXJ2aWNlOiBTdHJpcGVTZXJ2aWNlKSB7fVxuICBAT3V0cHV0KCkgcHVibGljIGNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8eyBjYXJkOiBhbnk7IGVsZW1lbnQ6IFN0cmlwZUVsZW1lbnQgfT4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBjb21wbGV0ZSA9IG5ldyBFdmVudEVtaXR0ZXI8eyBjYXJkOiBhbnk7IGVsZW1lbnQ6IFN0cmlwZUVsZW1lbnQgfT4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBlcnJvciA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBASW5wdXQoKSBwdWJsaWMgZWxlbWVudFR5cGVzOiBBcnJheTxFbGVtZW50VHlwZT4gPSBbJ2NhcmQnXTtcblxuICBAVmlld0NoaWxkKCdjYXJkJywgeyBzdGF0aWM6IGZhbHNlIH0pIHByaXZhdGUgY2FyZDogRWxlbWVudFJlZjtcbiAgcHJpdmF0ZSBjYXJkRWxlbWVudD86IFN0cmlwZUVsZW1lbnQ7XG4gIHByaXZhdGUgZWxlbWVudHM/OiBBcnJheTxTdHJpcGVFbGVtZW50PjtcbiAgcHJpdmF0ZSBvcHRpb25zJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RWxlbWVudE9wdGlvbnM+KHt9KTtcbiAgcHJpdmF0ZSBlbGVtZW50c09wdGlvbnMkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxFbGVtZW50c09wdGlvbnM+KHt9KTtcblxuICBwdWJsaWMgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIGNvbnN0IGVsZW1lbnRzJDogT2JzZXJ2YWJsZTxFbGVtZW50cz4gPSB0aGlzLmVsZW1lbnRzT3B0aW9ucyQuYXNPYnNlcnZhYmxlKCkucGlwZShcbiAgICAgIHN3aXRjaE1hcChvcHRpb25zID0+IHtcbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKG9wdGlvbnMpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5zdHJpcGVTZXJ2aWNlLmVsZW1lbnRzKG9wdGlvbnMpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnN0cmlwZVNlcnZpY2UuZWxlbWVudHMoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgICBsZXQgY29tcGxldGUgPSB7fTtcbiAgICBvYnNlcnZhYmxlQ29tYmluZUxhdGVzdChcbiAgICAgIGVsZW1lbnRzJCxcbiAgICAgIHRoaXMub3B0aW9ucyQuYXNPYnNlcnZhYmxlKCkucGlwZShmaWx0ZXIob3B0aW9ucyA9PiBCb29sZWFuKG9wdGlvbnMpKSlcbiAgICApLnN1YnNjcmliZSgoW2VsZW1lbnRzLCBvcHRpb25zXSkgPT4ge1xuICAgICAgdGhpcy5lbGVtZW50cyA9IFtdO1xuICAgICAgaWYgKHRoaXMuY2FyZCkge1xuICAgICAgICBmb3IgKGNvbnN0IHR5cGUgb2YgdGhpcy5lbGVtZW50VHlwZXMpIHtcbiAgICAgICAgICBjb25zdCBlbGVtZW50ID0gZWxlbWVudHMuY3JlYXRlKHR5cGUsIG9wdGlvbnMpO1xuICAgICAgICAgIGNvbXBsZXRlID0ge1xuICAgICAgICAgICAgLi4uY29tcGxldGUsXG4gICAgICAgICAgICBbdHlwZV06IGVsZW1lbnRcbiAgICAgICAgICB9O1xuXG4gICAgICAgICAgaWYgKFsnY2FyZCcsICdjYXJkTnVtYmVyJ10uaW5kZXhPZih0eXBlKSAhPT0gLTEpIHtcbiAgICAgICAgICAgIHRoaXMuY2FyZEVsZW1lbnQgPSBlbGVtZW50O1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBtb3VudFRvID0gdGhpcy5jYXJkLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcihgLiR7dHlwZX1gKTtcblxuICAgICAgICAgIGVsZW1lbnQubW91bnQobW91bnRUbyk7XG5cbiAgICAgICAgICBlbGVtZW50Lm9uKCdjaGFuZ2UnLCBjaGFuZ2VkQ2FyZCA9PiB7XG4gICAgICAgICAgICBsZXQgaXNDb21wbGV0ZSA9IGNoYW5nZWRDYXJkLmNvbXBsZXRlO1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gY29tcGxldGUpIHtcbiAgICAgICAgICAgICAgaWYgKGNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBjb21wbGV0ZVtrZXldO1xuICAgICAgICAgICAgICAgIGlmIChrZXkgIT09IGNoYW5nZWRDYXJkLmVsZW1lbnRUeXBlICYmICF2YWx1ZS5fY29tcGxldGUpIHtcbiAgICAgICAgICAgICAgICAgIGlzQ29tcGxldGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuY2hhbmdlLmVtaXQoe1xuICAgICAgICAgICAgICBjYXJkOiBjaGFuZ2VkQ2FyZCxcbiAgICAgICAgICAgICAgZWxlbWVudHM6IHRoaXMuZWxlbWVudHMsXG4gICAgICAgICAgICAgIHR5cGU6IGNoYW5nZWRDYXJkLmVsZW1lbnRUeXBlLFxuICAgICAgICAgICAgICBjb21wbGV0ZTogaXNDb21wbGV0ZSxcbiAgICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudFxuICAgICAgICAgICAgfSBhcyBhbnkpO1xuICAgICAgICAgICAgaWYgKGlzQ29tcGxldGUpIHtcbiAgICAgICAgICAgICAgdGhpcy5jb21wbGV0ZS5lbWl0KHtcbiAgICAgICAgICAgICAgICBjYXJkOiBjaGFuZ2VkQ2FyZCxcbiAgICAgICAgICAgICAgICBlbGVtZW50czogdGhpcy5lbGVtZW50cyxcbiAgICAgICAgICAgICAgICB0eXBlOiBjaGFuZ2VkQ2FyZC5lbGVtZW50VHlwZSxcbiAgICAgICAgICAgICAgICBjb21wbGV0ZTogaXNDb21wbGV0ZSxcbiAgICAgICAgICAgICAgICBlbGVtZW50OiBlbGVtZW50XG4gICAgICAgICAgICAgIH0gYXMgYW55KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjaGFuZ2VkQ2FyZC5lcnJvcikge1xuICAgICAgICAgICAgICB0aGlzLmVycm9yLmVtaXQoY2hhbmdlZENhcmQuZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMuZWxlbWVudHMgPSBbLi4udGhpcy5lbGVtZW50cywgZWxlbWVudF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDYXJkKCk6IFN0cmlwZUVsZW1lbnQgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLmNhcmRFbGVtZW50O1xuICB9XG59XG4iXX0=