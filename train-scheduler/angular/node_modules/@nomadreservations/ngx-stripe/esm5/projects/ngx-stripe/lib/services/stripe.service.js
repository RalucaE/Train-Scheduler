import * as tslib_1 from "tslib";
import { Inject, Injectable } from '@angular/core';
import { from as observableFrom, ReplaySubject } from 'rxjs';
import { filter, map, publishLast, refCount, take } from 'rxjs/operators';
import { isSourceData } from '../interfaces/sources';
import { STRIPE_OPTIONS, STRIPE_PUBLISHABLE_KEY } from '../interfaces/stripe';
import { isBankAccount, isBankAccountData, isPii, isPiiData } from '../interfaces/token';
import { LazyStripeAPILoader, Status } from './api-loader.service';
import { PlatformService } from './platform.service';
import { WindowRef } from './window-ref.service';
var StripeService = /** @class */ (function () {
    function StripeService(key, options, loader, window, _platform) {
        this.key = key;
        this.options = options;
        this.loader = loader;
        this.window = window;
        this._platform = _platform;
        this.stripeChanged$ = new ReplaySubject();
        this.stripe = {};
        this.changeKey(this.key, this.options)
            .pipe(take(1))
            .subscribe(function () { });
    }
    StripeService.prototype.changeKey = function (key, options) {
        var _this = this;
        var obs = this.loader.asStream().pipe(filter(function (status) { return status.loaded === true; }), map(function () {
            if (!_this.window.getNativeWindow()) {
                return;
            }
            var Stripe = _this.window.getNativeWindow().Stripe;
            if (key) {
                _this.stripe = options ? Stripe(key, options) : Stripe(key);
                _this.stripeChanged$.next(_this.stripe);
            }
            return _this.stripe;
        }), publishLast(), refCount());
        obs.subscribe();
        return obs;
    };
    StripeService.prototype.elements = function (options) {
        var _this = this;
        return this.stripeChanged$.pipe(map(function () { return _this.stripe.elements(options); }));
    };
    StripeService.prototype.createToken = function (a, b) {
        if (isBankAccount(a) && isBankAccountData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else if (isPii(a) && isPiiData(b)) {
            return observableFrom(this.stripe.createToken(a, b));
        }
        else {
            return observableFrom(this.stripe.createToken(a, b));
        }
    };
    StripeService.prototype.paymentRequest = function (options) {
        var _this = this;
        return this.stripeChanged$.pipe(map(function () { return _this.stripe.paymentRequest(options); }));
    };
    StripeService.prototype.handleCardSetup = function (clientSecret, element, cardSetupOptions) {
        return observableFrom(this.stripe.handleCardSetup(clientSecret, element, cardSetupOptions));
    };
    StripeService.prototype.handleCardPayment = function (clientSecret, element, cardSetupOptions) {
        return observableFrom(this.stripe.handleCardPayment(clientSecret, element, cardSetupOptions));
    };
    StripeService.prototype.handleCardAction = function (clientSecret) {
        return observableFrom(this.stripe.handleCardAction(clientSecret));
    };
    StripeService.prototype.confirmPaymentIntent = function (clientSecret, element, intentOptions) {
        return observableFrom(this.stripe.confirmPaymentIntent(clientSecret, element, intentOptions));
    };
    StripeService.prototype.confirmCardPayment = function (clientSecret, data, options) {
        return observableFrom(this.stripe.confirmCardPayment(clientSecret, data, options));
    };
    StripeService.prototype.retrievePaymentIntent = function (clientSecret) {
        return observableFrom(this.stripe.retrievePaymentIntent(clientSecret));
    };
    StripeService.prototype.retrieveSetupIntent = function (clientSecret) {
        return observableFrom(this.stripe.retrieveSetupIntent(clientSecret));
    };
    StripeService.prototype.confirmSetupIntent = function (clientSecret, element, intentOptions) {
        return observableFrom(this.stripe.confirmSetupIntent(clientSecret, element, intentOptions));
    };
    StripeService.prototype.createSource = function (a, b) {
        if (isSourceData(a)) {
            return observableFrom(this.stripe.createSource(a));
        }
        return observableFrom(this.stripe.createSource(a, b));
    };
    StripeService.prototype.retrieveSource = function (source) {
        return observableFrom(this.stripe.retrieveSource(source));
    };
    StripeService.prototype.createPaymentMethod = function (paymentMethod) {
        return observableFrom(this.stripe.createPaymentMethod(paymentMethod));
    };
    StripeService.ctorParameters = function () { return [
        { type: String, decorators: [{ type: Inject, args: [STRIPE_PUBLISHABLE_KEY,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [STRIPE_OPTIONS,] }] },
        { type: LazyStripeAPILoader },
        { type: WindowRef },
        { type: PlatformService }
    ]; };
    StripeService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(0, Inject(STRIPE_PUBLISHABLE_KEY)),
        tslib_1.__param(1, Inject(STRIPE_OPTIONS)),
        tslib_1.__metadata("design:paramtypes", [String, Object, LazyStripeAPILoader,
            WindowRef,
            PlatformService])
    ], StripeService);
    return StripeService;
}());
export { StripeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RyaXBlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abm9tYWRyZXNlcnZhdGlvbnMvbmd4LXN0cmlwZS9wcm9qZWN0cy9uZ3gtc3RyaXBlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3N0cmlwZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFHQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsSUFBSSxJQUFJLGNBQWMsRUFBYyxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDekUsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUcxRSxPQUFPLEVBQUUsWUFBWSxFQUEwQyxNQUFNLHVCQUF1QixDQUFDO0FBQzdGLE9BQU8sRUFBcUIsY0FBYyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDakcsT0FBTyxFQVVMLGFBQWEsRUFDYixpQkFBaUIsRUFDakIsS0FBSyxFQUNMLFNBQVMsRUFPVixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR2pEO0lBSUUsdUJBQzBDLEdBQVcsRUFDbkIsT0FBZ0IsRUFDeEMsTUFBMkIsRUFDM0IsTUFBaUIsRUFDakIsU0FBMEI7UUFKTSxRQUFHLEdBQUgsR0FBRyxDQUFRO1FBQ25CLFlBQU8sR0FBUCxPQUFPLENBQVM7UUFDeEMsV0FBTSxHQUFOLE1BQU0sQ0FBcUI7UUFDM0IsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUNqQixjQUFTLEdBQVQsU0FBUyxDQUFpQjtRQVI3QixtQkFBYyxHQUE0QixJQUFJLGFBQWEsRUFBRSxDQUFDO1FBQzdELFdBQU0sR0FBYSxFQUFjLENBQUM7UUFTeEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUM7YUFDbkMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNiLFNBQVMsQ0FBQyxjQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFTSxpQ0FBUyxHQUFoQixVQUFpQixHQUFXLEVBQUUsT0FBaUI7UUFBL0MsaUJBbUJDO1FBbEJDLElBQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxDQUNyQyxNQUFNLENBQUMsVUFBQyxNQUFjLElBQUssT0FBQSxNQUFNLENBQUMsTUFBTSxLQUFLLElBQUksRUFBdEIsQ0FBc0IsQ0FBQyxFQUNsRCxHQUFHLENBQUM7WUFDRixJQUFJLENBQUMsS0FBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLEVBQUUsRUFBRTtnQkFDbEMsT0FBTzthQUNSO1lBQ0QsSUFBTSxNQUFNLEdBQUksS0FBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLEVBQVUsQ0FBQyxNQUFNLENBQUM7WUFDN0QsSUFBSSxHQUFHLEVBQUU7Z0JBQ1AsS0FBSSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFFLE1BQU0sQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFjLENBQUMsQ0FBQyxDQUFFLE1BQU0sQ0FBQyxHQUFHLENBQWMsQ0FBQztnQkFDdkYsS0FBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3ZDO1lBQ0QsT0FBTyxLQUFJLENBQUMsTUFBTSxDQUFDO1FBQ3JCLENBQUMsQ0FBQyxFQUNGLFdBQVcsRUFBRSxFQUNiLFFBQVEsRUFBRSxDQUNYLENBQUM7UUFDRixHQUFHLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDaEIsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0lBRU0sZ0NBQVEsR0FBZixVQUFnQixPQUF5QjtRQUF6QyxpQkFFQztRQURDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBN0IsQ0FBNkIsQ0FBQyxDQUFDLENBQUM7SUFDNUUsQ0FBQztJQUVNLG1DQUFXLEdBQWxCLFVBQ0UsQ0FBOEIsRUFDOUIsQ0FBMEQ7UUFFMUQsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksaUJBQWlCLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDNUMsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDdEQ7YUFBTSxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDbkMsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDdEQ7YUFBTTtZQUNMLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQVksRUFBRSxDQUFnQyxDQUFDLENBQUMsQ0FBQztTQUNoRztJQUNILENBQUM7SUFFTSxzQ0FBYyxHQUFyQixVQUFzQixPQUE4QjtRQUFwRCxpQkFFQztRQURDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsRUFBbkMsQ0FBbUMsQ0FBQyxDQUFDLENBQUM7SUFDbEYsQ0FBQztJQUVNLHVDQUFlLEdBQXRCLFVBQ0UsWUFBb0IsRUFDcEIsT0FBZ0IsRUFDaEIsZ0JBQThDO1FBRTlDLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLFlBQVksRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO0lBQzlGLENBQUM7SUFFTSx5Q0FBaUIsR0FBeEIsVUFDRSxZQUFvQixFQUNwQixPQUFnQixFQUNoQixnQkFBOEM7UUFFOUMsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQztJQUNoRyxDQUFDO0lBRU0sd0NBQWdCLEdBQXZCLFVBQXdCLFlBQW9CO1FBQzFDLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBRU0sNENBQW9CLEdBQTNCLFVBQ0UsWUFBb0IsRUFDcEIsT0FBZ0IsRUFDaEIsYUFBNkM7UUFFN0MsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxZQUFZLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUM7SUFDaEcsQ0FBQztJQUVNLDBDQUFrQixHQUF6QixVQUNFLFlBQW9CLEVBQ3BCLElBQTRCLEVBQzVCLE9BQStDO1FBRS9DLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsWUFBWSxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3JGLENBQUM7SUFFTSw2Q0FBcUIsR0FBNUIsVUFBNkIsWUFBb0I7UUFDL0MsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFFTSwyQ0FBbUIsR0FBMUIsVUFBMkIsWUFBb0I7UUFDN0MsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7SUFFTSwwQ0FBa0IsR0FBekIsVUFDRSxZQUFvQixFQUNwQixPQUFnQixFQUNoQixhQUFrRDtRQUVsRCxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFlBQVksRUFBRSxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQztJQUM5RixDQUFDO0lBRU0sb0NBQVksR0FBbkIsVUFBb0IsQ0FBdUIsRUFBRSxDQUEwQjtRQUNyRSxJQUFJLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNuQixPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFlLENBQUMsQ0FBQyxDQUFDO1NBQ2xFO1FBQ0QsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbkUsQ0FBQztJQUVNLHNDQUFjLEdBQXJCLFVBQXNCLE1BQW9CO1FBQ3hDLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUVNLDJDQUFtQixHQUExQixVQUEyQixhQUFrQztRQUMzRCxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7SUFDeEUsQ0FBQzs7NkNBdEhFLE1BQU0sU0FBQyxzQkFBc0I7Z0RBQzdCLE1BQU0sU0FBQyxjQUFjO2dCQUNOLG1CQUFtQjtnQkFDbkIsU0FBUztnQkFDTixlQUFlOztJQVR6QixhQUFhO1FBRHpCLFVBQVUsRUFBRTtRQU1SLG1CQUFBLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBO1FBQzlCLG1CQUFBLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQTtpRUFDUCxtQkFBbUI7WUFDbkIsU0FBUztZQUNOLGVBQWU7T0FUekIsYUFBYSxDQTRIekI7SUFBRCxvQkFBQztDQUFBLEFBNUhELElBNEhDO1NBNUhZLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYXltZW50TWV0aG9kUGFyYW1zLCBQYXltZW50TWV0aG9kUmVzdWx0IH0gZnJvbSAnLi8uLi9pbnRlcmZhY2VzL3BheW1lbnQtbWV0aG9kJztcbmRlY2xhcmUgdmFyIFN0cmlwZTtcblxuaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmcm9tIGFzIG9ic2VydmFibGVGcm9tLCBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgcHVibGlzaExhc3QsIHJlZkNvdW50LCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRWxlbWVudCwgUmVxdWVzdEVsZW1lbnRPcHRpb25zIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9lbGVtZW50JztcbmltcG9ydCB7IEVsZW1lbnRzLCBFbGVtZW50c09wdGlvbnMgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2VsZW1lbnRzJztcbmltcG9ydCB7IGlzU291cmNlRGF0YSwgU291cmNlRGF0YSwgU291cmNlUGFyYW1zLCBTb3VyY2VSZXN1bHQgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3NvdXJjZXMnO1xuaW1wb3J0IHsgT3B0aW9ucywgU3RyaXBlSlMsIFNUUklQRV9PUFRJT05TLCBTVFJJUEVfUFVCTElTSEFCTEVfS0VZIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9zdHJpcGUnO1xuaW1wb3J0IHtcbiAgQmFua0FjY291bnQsXG4gIEJhbmtBY2NvdW50RGF0YSxcbiAgQ2FyZERhdGFPcHRpb25zLFxuICBDYXJkUGF5bWVudERhdGEsXG4gIENvbmZpcm1DYXJkUGF5bWVudERhdGEsXG4gIENvbmZpcm1DYXJkUGF5bWVudE9wdGlvbnMsXG4gIENvbmZpcm1DYXJkUGF5bWVudFJlc3VsdCxcbiAgQ29uZmlybUludGVudERhdGEsXG4gIENvbmZpcm1TZXR1cEludGVudERhdGEsXG4gIGlzQmFua0FjY291bnQsXG4gIGlzQmFua0FjY291bnREYXRhLFxuICBpc1BpaSxcbiAgaXNQaWlEYXRhLFxuICBQYXltZW50SW50ZW50UmVzdWx0LFxuICBQaWksXG4gIFBpaURhdGEsXG4gIFNldHVwSW50ZW50RGF0YSxcbiAgU2V0dXBJbnRlbnRSZXN1bHQsXG4gIFRva2VuUmVzdWx0XG59IGZyb20gJy4uL2ludGVyZmFjZXMvdG9rZW4nO1xuaW1wb3J0IHsgTGF6eVN0cmlwZUFQSUxvYWRlciwgU3RhdHVzIH0gZnJvbSAnLi9hcGktbG9hZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgUGxhdGZvcm1TZXJ2aWNlIH0gZnJvbSAnLi9wbGF0Zm9ybS5zZXJ2aWNlJztcbmltcG9ydCB7IFdpbmRvd1JlZiB9IGZyb20gJy4vd2luZG93LXJlZi5zZXJ2aWNlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFN0cmlwZVNlcnZpY2Uge1xuICBwdWJsaWMgc3RyaXBlQ2hhbmdlZCQ6IFJlcGxheVN1YmplY3Q8U3RyaXBlSlM+ID0gbmV3IFJlcGxheVN1YmplY3QoKTtcbiAgcHJpdmF0ZSBzdHJpcGU6IFN0cmlwZUpTID0ge30gYXMgU3RyaXBlSlM7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChTVFJJUEVfUFVCTElTSEFCTEVfS0VZKSBwcml2YXRlIGtleTogc3RyaW5nLFxuICAgIEBJbmplY3QoU1RSSVBFX09QVElPTlMpIHByaXZhdGUgb3B0aW9uczogT3B0aW9ucyxcbiAgICBwcml2YXRlIGxvYWRlcjogTGF6eVN0cmlwZUFQSUxvYWRlcixcbiAgICBwcml2YXRlIHdpbmRvdzogV2luZG93UmVmLFxuICAgIHByaXZhdGUgX3BsYXRmb3JtOiBQbGF0Zm9ybVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5jaGFuZ2VLZXkodGhpcy5rZXksIHRoaXMub3B0aW9ucylcbiAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHt9KTtcbiAgfVxuXG4gIHB1YmxpYyBjaGFuZ2VLZXkoa2V5OiBzdHJpbmcsIG9wdGlvbnM/OiBPcHRpb25zKTogT2JzZXJ2YWJsZTxTdHJpcGVKUyB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IG9icyA9IHRoaXMubG9hZGVyLmFzU3RyZWFtKCkucGlwZShcbiAgICAgIGZpbHRlcigoc3RhdHVzOiBTdGF0dXMpID0+IHN0YXR1cy5sb2FkZWQgPT09IHRydWUpLFxuICAgICAgbWFwKCgpID0+IHtcbiAgICAgICAgaWYgKCF0aGlzLndpbmRvdy5nZXROYXRpdmVXaW5kb3coKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBTdHJpcGUgPSAodGhpcy53aW5kb3cuZ2V0TmF0aXZlV2luZG93KCkgYXMgYW55KS5TdHJpcGU7XG4gICAgICAgIGlmIChrZXkpIHtcbiAgICAgICAgICB0aGlzLnN0cmlwZSA9IG9wdGlvbnMgPyAoU3RyaXBlKGtleSwgb3B0aW9ucykgYXMgU3RyaXBlSlMpIDogKFN0cmlwZShrZXkpIGFzIFN0cmlwZUpTKTtcbiAgICAgICAgICB0aGlzLnN0cmlwZUNoYW5nZWQkLm5leHQodGhpcy5zdHJpcGUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnN0cmlwZTtcbiAgICAgIH0pLFxuICAgICAgcHVibGlzaExhc3QoKSxcbiAgICAgIHJlZkNvdW50KClcbiAgICApO1xuICAgIG9icy5zdWJzY3JpYmUoKTtcbiAgICByZXR1cm4gb2JzO1xuICB9XG5cbiAgcHVibGljIGVsZW1lbnRzKG9wdGlvbnM/OiBFbGVtZW50c09wdGlvbnMpOiBPYnNlcnZhYmxlPEVsZW1lbnRzPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RyaXBlQ2hhbmdlZCQucGlwZShtYXAoKCkgPT4gdGhpcy5zdHJpcGUuZWxlbWVudHMob3B0aW9ucykpKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVUb2tlbihcbiAgICBhOiBFbGVtZW50IHwgQmFua0FjY291bnQgfCBQaWksXG4gICAgYjogQ2FyZERhdGFPcHRpb25zIHwgQmFua0FjY291bnREYXRhIHwgUGlpRGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFRva2VuUmVzdWx0PiB7XG4gICAgaWYgKGlzQmFua0FjY291bnQoYSkgJiYgaXNCYW5rQWNjb3VudERhdGEoYikpIHtcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jcmVhdGVUb2tlbihhLCBiKSk7XG4gICAgfSBlbHNlIGlmIChpc1BpaShhKSAmJiBpc1BpaURhdGEoYikpIHtcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jcmVhdGVUb2tlbihhLCBiKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jcmVhdGVUb2tlbihhIGFzIEVsZW1lbnQsIGIgYXMgQ2FyZERhdGFPcHRpb25zIHwgdW5kZWZpbmVkKSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHBheW1lbnRSZXF1ZXN0KG9wdGlvbnM6IFJlcXVlc3RFbGVtZW50T3B0aW9ucyk6IE9ic2VydmFibGU8RWxlbWVudD4ge1xuICAgIHJldHVybiB0aGlzLnN0cmlwZUNoYW5nZWQkLnBpcGUobWFwKCgpID0+IHRoaXMuc3RyaXBlLnBheW1lbnRSZXF1ZXN0KG9wdGlvbnMpKSk7XG4gIH1cblxuICBwdWJsaWMgaGFuZGxlQ2FyZFNldHVwKFxuICAgIGNsaWVudFNlY3JldDogc3RyaW5nLFxuICAgIGVsZW1lbnQ6IEVsZW1lbnQsXG4gICAgY2FyZFNldHVwT3B0aW9ucz86IFNldHVwSW50ZW50RGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFNldHVwSW50ZW50UmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmhhbmRsZUNhcmRTZXR1cChjbGllbnRTZWNyZXQsIGVsZW1lbnQsIGNhcmRTZXR1cE9wdGlvbnMpKTtcbiAgfVxuXG4gIHB1YmxpYyBoYW5kbGVDYXJkUGF5bWVudChcbiAgICBjbGllbnRTZWNyZXQ6IHN0cmluZyxcbiAgICBlbGVtZW50OiBFbGVtZW50LFxuICAgIGNhcmRTZXR1cE9wdGlvbnM/OiBDYXJkUGF5bWVudERhdGEgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxQYXltZW50SW50ZW50UmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmhhbmRsZUNhcmRQYXltZW50KGNsaWVudFNlY3JldCwgZWxlbWVudCwgY2FyZFNldHVwT3B0aW9ucykpO1xuICB9XG5cbiAgcHVibGljIGhhbmRsZUNhcmRBY3Rpb24oY2xpZW50U2VjcmV0OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFBheW1lbnRJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUuaGFuZGxlQ2FyZEFjdGlvbihjbGllbnRTZWNyZXQpKTtcbiAgfVxuXG4gIHB1YmxpYyBjb25maXJtUGF5bWVudEludGVudChcbiAgICBjbGllbnRTZWNyZXQ6IHN0cmluZyxcbiAgICBlbGVtZW50OiBFbGVtZW50LFxuICAgIGludGVudE9wdGlvbnM/OiBDb25maXJtSW50ZW50RGF0YSB8IHVuZGVmaW5lZFxuICApOiBPYnNlcnZhYmxlPFNldHVwSW50ZW50UmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNvbmZpcm1QYXltZW50SW50ZW50KGNsaWVudFNlY3JldCwgZWxlbWVudCwgaW50ZW50T3B0aW9ucykpO1xuICB9XG5cbiAgcHVibGljIGNvbmZpcm1DYXJkUGF5bWVudChcbiAgICBjbGllbnRTZWNyZXQ6IHN0cmluZyxcbiAgICBkYXRhOiBDb25maXJtQ2FyZFBheW1lbnREYXRhLFxuICAgIG9wdGlvbnM/OiBDb25maXJtQ2FyZFBheW1lbnRPcHRpb25zIHwgdW5kZWZpbmVkXG4gICk6IE9ic2VydmFibGU8Q29uZmlybUNhcmRQYXltZW50UmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNvbmZpcm1DYXJkUGF5bWVudChjbGllbnRTZWNyZXQsIGRhdGEsIG9wdGlvbnMpKTtcbiAgfVxuXG4gIHB1YmxpYyByZXRyaWV2ZVBheW1lbnRJbnRlbnQoY2xpZW50U2VjcmV0OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFBheW1lbnRJbnRlbnRSZXN1bHQ+IHtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb20odGhpcy5zdHJpcGUucmV0cmlldmVQYXltZW50SW50ZW50KGNsaWVudFNlY3JldCkpO1xuICB9XG5cbiAgcHVibGljIHJldHJpZXZlU2V0dXBJbnRlbnQoY2xpZW50U2VjcmV0OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFNldHVwSW50ZW50UmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLnJldHJpZXZlU2V0dXBJbnRlbnQoY2xpZW50U2VjcmV0KSk7XG4gIH1cblxuICBwdWJsaWMgY29uZmlybVNldHVwSW50ZW50KFxuICAgIGNsaWVudFNlY3JldDogc3RyaW5nLFxuICAgIGVsZW1lbnQ6IEVsZW1lbnQsXG4gICAgaW50ZW50T3B0aW9ucz86IENvbmZpcm1TZXR1cEludGVudERhdGEgfCB1bmRlZmluZWRcbiAgKTogT2JzZXJ2YWJsZTxTZXR1cEludGVudFJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jb25maXJtU2V0dXBJbnRlbnQoY2xpZW50U2VjcmV0LCBlbGVtZW50LCBpbnRlbnRPcHRpb25zKSk7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlU291cmNlKGE6IEVsZW1lbnQgfCBTb3VyY2VEYXRhLCBiPzogU291cmNlRGF0YSB8IHVuZGVmaW5lZCk6IE9ic2VydmFibGU8U291cmNlUmVzdWx0PiB7XG4gICAgaWYgKGlzU291cmNlRGF0YShhKSkge1xuICAgICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNyZWF0ZVNvdXJjZShhIGFzIFNvdXJjZURhdGEpKTtcbiAgICB9XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLmNyZWF0ZVNvdXJjZShhIGFzIEVsZW1lbnQsIGIpKTtcbiAgfVxuXG4gIHB1YmxpYyByZXRyaWV2ZVNvdXJjZShzb3VyY2U6IFNvdXJjZVBhcmFtcyk6IE9ic2VydmFibGU8U291cmNlUmVzdWx0PiB7XG4gICAgcmV0dXJuIG9ic2VydmFibGVGcm9tKHRoaXMuc3RyaXBlLnJldHJpZXZlU291cmNlKHNvdXJjZSkpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVBheW1lbnRNZXRob2QocGF5bWVudE1ldGhvZDogUGF5bWVudE1ldGhvZFBhcmFtcyk6IE9ic2VydmFibGU8UGF5bWVudE1ldGhvZFJlc3VsdD4ge1xuICAgIHJldHVybiBvYnNlcnZhYmxlRnJvbSh0aGlzLnN0cmlwZS5jcmVhdGVQYXltZW50TWV0aG9kKHBheW1lbnRNZXRob2QpKTtcbiAgfVxufVxuIl19